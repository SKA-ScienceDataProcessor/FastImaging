<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.14"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Slow Transients Pipeline Prototype: /home/lucas/skadev/FastImaging/src/stp/gridder/gridder.h Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="science_data_processor_logo.jpg"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Slow Transients Pipeline Prototype
   </div>
   <div id="projectbrief">Component of the Science Data Processor being developed in the context of the Square Kilometre Array international project, which provides fast snapshot imaging, object detection and cataloguing for the identification of astrophysical image-plane transients.</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.14 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="dir_68267d1309a1af8e8297ef4c3efbcdba.html">src</a></li><li class="navelem"><a class="el" href="dir_71906deff00c706128a95d3938125d0a.html">stp</a></li><li class="navelem"><a class="el" href="dir_84de9b9706c9fd6890d1de19f7b2d5de.html">gridder</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">gridder.h</div>  </div>
</div><!--header-->
<div class="contents">
<a href="gridder_8h.html">Go to the documentation of this file.</a><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;</div><div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;<span class="preprocessor">#ifndef GRIDDER_H</span></div><div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;<span class="preprocessor">#define GRIDDER_H</span></div><div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;</div><div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;<span class="preprocessor">#include &lt;cassert&gt;</span></div><div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;<span class="preprocessor">#include &lt;cfloat&gt;</span></div><div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;<span class="preprocessor">#include &lt;map&gt;</span></div><div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;<span class="preprocessor">#include &lt;tbb/tbb.h&gt;</span></div><div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;</div><div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;<span class="preprocessor">#include &quot;../common/fft.h&quot;</span></div><div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;<span class="preprocessor">#include &quot;../common/matstp.h&quot;</span></div><div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;<span class="preprocessor">#include &quot;../convolution/conv_func.h&quot;</span></div><div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;<span class="preprocessor">#include &quot;../global_macros.h&quot;</span></div><div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;<span class="preprocessor">#include &quot;../types.h&quot;</span></div><div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="aw__projection_8h.html">aw_projection.h</a>&quot;</span></div><div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;</div><div class="line"><a name="l00020"></a><span class="lineno"><a class="line" href="gridder_8h.html#ad560e7fb8564c991d39374775a382e80">   20</a></span>&#160;<span class="preprocessor">#define arc_sec_to_rad(value) ((value / 3600.0) * (M_PI / 180.0))</span></div><div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;</div><div class="line"><a name="l00022"></a><span class="lineno"><a class="line" href="gridder_8h.html#abff42c55084e0b508b14296f75b323a3">   22</a></span>&#160;<span class="preprocessor">#define UVW_GRIDDER</span></div><div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;</div><div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;<span class="keyword">namespace </span><a class="code" href="namespacestp.html">stp</a> {</div><div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;</div><div class="line"><a name="l00031"></a><span class="lineno"><a class="line" href="classstp_1_1_gridder_output.html">   31</a></span>&#160;<span class="keyword">class </span><a class="code" href="classstp_1_1_gridder_output.html">GridderOutput</a> {</div><div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;<span class="keyword">public</span>:</div><div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;    <a class="code" href="classstp_1_1_gridder_output.html#a875fc3decf005dff279ed0d43195942b">GridderOutput</a>() = <span class="keywordflow">default</span>;</div><div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;</div><div class="line"><a name="l00041"></a><span class="lineno"><a class="line" href="classstp_1_1_gridder_output.html#a7de6a41a043d64b12e4b583e612e868c">   41</a></span>&#160;    <a class="code" href="classstp_1_1_gridder_output.html#a7de6a41a043d64b12e4b583e612e868c">GridderOutput</a>(<a class="code" href="classstp_1_1_mat_stp.html">MatStp&lt;cx_real_t&gt;</a>&amp; in_vis_grid, <a class="code" href="classstp_1_1_mat_stp.html">MatStp&lt;cx_real_t&gt;</a>&amp; in_sampling_grid, <span class="keywordtype">double</span> in_sampling_total)</div><div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;        : <a class="code" href="classstp_1_1_gridder_output.html#a49a6dc4b250eff5150ec560daf3c33f5">vis_grid</a>(std::move(in_vis_grid))</div><div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;        , <a class="code" href="classstp_1_1_gridder_output.html#a02d28321016ab51f04ecb17431583d8c">sampling_grid</a>(std::move(in_sampling_grid))</div><div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;        , <a class="code" href="classstp_1_1_gridder_output.html#a7e3e3dc1f24e7c5e3caff9611bd0e298">sample_grid_total</a>(in_sampling_total)</div><div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;    {</div><div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;    }</div><div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;</div><div class="line"><a name="l00051"></a><span class="lineno"><a class="line" href="classstp_1_1_gridder_output.html#a49a6dc4b250eff5150ec560daf3c33f5">   51</a></span>&#160;    <a class="code" href="classstp_1_1_mat_stp.html">MatStp&lt;cx_real_t&gt;</a> <a class="code" href="classstp_1_1_gridder_output.html#a49a6dc4b250eff5150ec560daf3c33f5">vis_grid</a>;</div><div class="line"><a name="l00055"></a><span class="lineno"><a class="line" href="classstp_1_1_gridder_output.html#a02d28321016ab51f04ecb17431583d8c">   55</a></span>&#160;    <a class="code" href="classstp_1_1_mat_stp.html">MatStp&lt;cx_real_t&gt;</a> <a class="code" href="classstp_1_1_gridder_output.html#a02d28321016ab51f04ecb17431583d8c">sampling_grid</a>;</div><div class="line"><a name="l00059"></a><span class="lineno"><a class="line" href="classstp_1_1_gridder_output.html#a7e3e3dc1f24e7c5e3caff9611bd0e298">   59</a></span>&#160;    <span class="keywordtype">double</span> <a class="code" href="classstp_1_1_gridder_output.html#a7e3e3dc1f24e7c5e3caff9611bd0e298">sample_grid_total</a>;</div><div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;};</div><div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;</div><div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;<span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</div><div class="line"><a name="l00076"></a><span class="lineno"><a class="line" href="namespacestp.html#a19e8b064e439617289907aeed2c00c76">   76</a></span>&#160;arma::field&lt;arma::Mat&lt;cx_real_t&gt;&gt; <a class="code" href="namespacestp.html#a19e8b064e439617289907aeed2c00c76">populate_kernel_cache</a>(<span class="keyword">const</span> T&amp; kernel_creator, <span class="keyword">const</span> <span class="keywordtype">int</span> support, <span class="keyword">const</span> <span class="keywordtype">int</span> oversampling, <span class="keyword">const</span> <span class="keywordtype">bool</span> pad = <span class="keyword">false</span>, <span class="keyword">const</span> <span class="keywordtype">bool</span> normalize = <span class="keyword">true</span>)</div><div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;{</div><div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;    <span class="keywordtype">int</span> oversampled_pixel = (oversampling / 2);</div><div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;    <span class="keywordtype">int</span> cache_size = (oversampled_pixel * 2 + 1);</div><div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;</div><div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;    arma::mat oversampled_pixel_offsets = (arma::linspace(0, cache_size - 1, cache_size) - oversampled_pixel) / oversampling;</div><div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;    arma::field&lt;arma::Mat&lt;cx_real_t&gt;&gt; cache(cache_size, cache_size); <span class="comment">// 2D kernel array cache to be returned</span></div><div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;    arma::field&lt;arma::mat&gt; kernel1D_cache(cache_size); <span class="comment">// Temporary cache for 1D kernel arrays</span></div><div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;</div><div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;    <span class="comment">// Fill 1D kernel array cache</span></div><div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; cache_size; i++) {</div><div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;        kernel1D_cache(i) = <a class="code" href="namespacestp.html#aae328999b307d32ea32e65caa64eac0b">make_1D_kernel</a>(kernel_creator, support, oversampled_pixel_offsets[i], 1, pad, normalize);</div><div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;    }</div><div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;    <span class="keywordtype">size_t</span> kernel_size = kernel1D_cache(0).n_elem;</div><div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;</div><div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;    <span class="comment">// Generate 2D kernel array cache based on 1D kernel cache for reduced running times</span></div><div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; cache_size; i++) {</div><div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j = 0; j &lt;= i; j++) {</div><div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;            cache(j, i).set_size(kernel_size, kernel_size);</div><div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;            <span class="comment">// Perfom dot product</span></div><div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;            <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> ii = 0; ii &lt; kernel_size; ii++) {</div><div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;                <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> jj = 0; jj &lt; kernel_size; jj++) {</div><div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;                    cache(j, i).at(jj, ii) = kernel1D_cache(j).at(jj) * kernel1D_cache(i).at(ii);</div><div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;                }</div><div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;            }</div><div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;            <span class="keywordflow">if</span> (i != j)</div><div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;                cache(i, j) = cache(j, i).st();</div><div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;        }</div><div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;    }</div><div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;</div><div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;    <span class="keywordflow">return</span> std::move(cache);</div><div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;}</div><div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;</div><div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;<span class="keywordtype">void</span> <a class="code" href="namespacestp.html#ad75e5145b07b51b813ec9eaa95e5ac93">convert_to_halfplane_visibilities</a>(arma::mat&amp; uv_lambda, arma::vec&amp; w_lambda, arma::cx_mat&amp; vis, <span class="keywordtype">int</span> kernel_support, arma::uvec&amp; good_vis);</div><div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160;</div><div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160;<span class="keywordtype">void</span> <a class="code" href="namespacestp.html#ad75e5145b07b51b813ec9eaa95e5ac93">convert_to_halfplane_visibilities</a>(arma::mat&amp; uv_lambda, arma::cx_mat&amp; vis, <span class="keywordtype">int</span> kernel_support, arma::uvec&amp; good_vis);</div><div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;</div><div class="line"><a name="l00141"></a><span class="lineno">  141</span>&#160;<span class="keywordtype">void</span> <a class="code" href="namespacestp.html#ac088200d449ac7f780530a45d80f9775">average_w_planes</a>(arma::mat w_lambda, <span class="keyword">const</span> arma::uvec&amp; good_vis, <span class="keywordtype">int</span> num_wplanes, arma::vec&amp; w_avg_values, arma::ivec&amp; w_planes_idx, <span class="keywordtype">bool</span> median = <span class="keyword">false</span>);</div><div class="line"><a name="l00142"></a><span class="lineno">  142</span>&#160;</div><div class="line"><a name="l00153"></a><span class="lineno">  153</span>&#160;<span class="keywordtype">void</span> <a class="code" href="namespacestp.html#a39093b21b3a22c0e0afcef9127a185f6">bounds_check_kernel_centre_locations</a>(arma::uvec&amp; good_vis, <span class="keyword">const</span> arma::imat&amp; kernel_centre_on_grid, <span class="keywordtype">int</span> image_size, <span class="keywordtype">int</span> support);</div><div class="line"><a name="l00154"></a><span class="lineno">  154</span>&#160;</div><div class="line"><a name="l00165"></a><span class="lineno">  165</span>&#160;arma::imat <a class="code" href="namespacestp.html#ad2191add2b4abbc6ff7cb8c4102097ca">calculate_oversampled_kernel_indices</a>(arma::mat&amp; subpixel_coord, <span class="keywordtype">int</span> oversampling);</div><div class="line"><a name="l00166"></a><span class="lineno">  166</span>&#160;</div><div class="line"><a name="l00217"></a><span class="lineno">  217</span>&#160;<span class="keyword">template</span> &lt;<span class="keywordtype">bool</span> generateBeam = true, <span class="keyword">typename</span> T&gt;</div><div class="line"><a name="l00218"></a><span class="lineno"><a class="line" href="namespacestp.html#a8135d9e95f2df8f47c170daa507a5a7a">  218</a></span>&#160;<a class="code" href="classstp_1_1_gridder_output.html">GridderOutput</a> <a class="code" href="namespacestp.html#a8135d9e95f2df8f47c170daa507a5a7a">convolve_to_grid</a>(</div><div class="line"><a name="l00219"></a><span class="lineno">  219</span>&#160;    <span class="keyword">const</span> T&amp; kernel_creator,</div><div class="line"><a name="l00220"></a><span class="lineno">  220</span>&#160;    <span class="keyword">const</span> <span class="keywordtype">int</span> support,</div><div class="line"><a name="l00221"></a><span class="lineno">  221</span>&#160;    <span class="keywordtype">int</span> image_size,</div><div class="line"><a name="l00222"></a><span class="lineno">  222</span>&#160;    arma::mat uv_lambda,</div><div class="line"><a name="l00223"></a><span class="lineno">  223</span>&#160;    arma::cx_mat vis,</div><div class="line"><a name="l00224"></a><span class="lineno">  224</span>&#160;    arma::mat vis_weights,</div><div class="line"><a name="l00225"></a><span class="lineno">  225</span>&#160;    <span class="keywordtype">bool</span> kernel_exact = <span class="keyword">true</span>,</div><div class="line"><a name="l00226"></a><span class="lineno">  226</span>&#160;    <span class="keywordtype">int</span> oversampling = 1,</div><div class="line"><a name="l00227"></a><span class="lineno">  227</span>&#160;    <span class="keywordtype">bool</span> shift_uv = <span class="keyword">true</span>,</div><div class="line"><a name="l00228"></a><span class="lineno">  228</span>&#160;    <span class="keywordtype">bool</span> halfplane_gridding = <span class="keyword">true</span>,</div><div class="line"><a name="l00229"></a><span class="lineno">  229</span>&#160;    <span class="keyword">const</span> <a class="code" href="structstp_1_1_w___projection_pars.html">W_ProjectionPars</a>&amp; w_proj = <a class="code" href="structstp_1_1_w___projection_pars.html">W_ProjectionPars</a>(),</div><div class="line"><a name="l00230"></a><span class="lineno">  230</span>&#160;    arma::vec w_lambda = arma::vec(),</div><div class="line"><a name="l00231"></a><span class="lineno">  231</span>&#160;    <span class="keywordtype">double</span> cell_size = 0.0,</div><div class="line"><a name="l00232"></a><span class="lineno">  232</span>&#160;    <span class="keywordtype">bool</span> analytic_gcf = <span class="keyword">true</span>,</div><div class="line"><a name="l00233"></a><span class="lineno">  233</span>&#160;    <a class="code" href="namespacestp.html#a464d541245c3d8f9ea82f5d2d5484c98">FFTRoutine</a> r_fft = <a class="code" href="namespacestp.html#a464d541245c3d8f9ea82f5d2d5484c98a1551a8f00e3ff5f46b18636fb963ad8c">FFTRoutine::FFTW_ESTIMATE_FFT</a>,</div><div class="line"><a name="l00234"></a><span class="lineno">  234</span>&#160;    <span class="keyword">const</span> <a class="code" href="structstp_1_1_a___projection_pars.html">A_ProjectionPars</a>&amp; a_proj = <a class="code" href="structstp_1_1_a___projection_pars.html">A_ProjectionPars</a>())</div><div class="line"><a name="l00235"></a><span class="lineno">  235</span>&#160;{</div><div class="line"><a name="l00236"></a><span class="lineno">  236</span>&#160;    <span class="keywordtype">bool</span> use_wproj = w_proj.isEnabled();</div><div class="line"><a name="l00237"></a><span class="lineno">  237</span>&#160;    <span class="keywordtype">bool</span> use_aproj = a_proj.isEnabled();</div><div class="line"><a name="l00238"></a><span class="lineno">  238</span>&#160;</div><div class="line"><a name="l00239"></a><span class="lineno">  239</span>&#160;    <span class="comment">// Half image size</span></div><div class="line"><a name="l00240"></a><span class="lineno">  240</span>&#160;    <span class="keyword">const</span> <span class="keywordtype">int</span> half_image_size = (image_size / 2);</div><div class="line"><a name="l00241"></a><span class="lineno">  241</span>&#160;    <span class="comment">// Set convolution kernel support for gridding</span></div><div class="line"><a name="l00242"></a><span class="lineno">  242</span>&#160;    <span class="keywordtype">int</span> conv_support = support;</div><div class="line"><a name="l00243"></a><span class="lineno">  243</span>&#160;</div><div class="line"><a name="l00244"></a><span class="lineno">  244</span>&#160;    <span class="comment">/* Some checks ***/</span></div><div class="line"><a name="l00245"></a><span class="lineno">  245</span>&#160;    assert(uv_lambda.n_cols == 2);</div><div class="line"><a name="l00246"></a><span class="lineno">  246</span>&#160;    assert(uv_lambda.n_rows == vis.n_rows);</div><div class="line"><a name="l00247"></a><span class="lineno">  247</span>&#160;<span class="preprocessor">#ifdef WPROJECTION</span></div><div class="line"><a name="l00248"></a><span class="lineno">  248</span>&#160;    <span class="keywordflow">if</span> (use_wproj)</div><div class="line"><a name="l00249"></a><span class="lineno">  249</span>&#160;        assert(w_lambda.n_rows == vis.n_rows);</div><div class="line"><a name="l00250"></a><span class="lineno">  250</span>&#160;    <span class="keywordflow">else</span></div><div class="line"><a name="l00251"></a><span class="lineno">  251</span>&#160;        w_lambda = arma::zeros&lt;arma::vec&gt;(vis.n_rows);</div><div class="line"><a name="l00252"></a><span class="lineno">  252</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l00253"></a><span class="lineno">  253</span>&#160;    assert(kernel_exact || (oversampling &gt;= 1));</div><div class="line"><a name="l00254"></a><span class="lineno">  254</span>&#160;    assert((image_size % 2) == 0);</div><div class="line"><a name="l00255"></a><span class="lineno">  255</span>&#160;    assert(vis.n_elem == vis_weights.n_elem);</div><div class="line"><a name="l00256"></a><span class="lineno">  256</span>&#160;    <span class="keywordflow">if</span> (use_aproj) {</div><div class="line"><a name="l00257"></a><span class="lineno">  257</span>&#160;        assert(!kernel_exact);</div><div class="line"><a name="l00258"></a><span class="lineno">  258</span>&#160;        assert(use_wproj);</div><div class="line"><a name="l00259"></a><span class="lineno">  259</span>&#160;        assert(!w_proj.hankel_opt);</div><div class="line"><a name="l00260"></a><span class="lineno">  260</span>&#160;    }</div><div class="line"><a name="l00261"></a><span class="lineno">  261</span>&#160;</div><div class="line"><a name="l00262"></a><span class="lineno">  262</span>&#160;<span class="comment">// Gridder options selection</span></div><div class="line"><a name="l00263"></a><span class="lineno">  263</span>&#160;<span class="preprocessor">#ifdef WPROJECTION</span></div><div class="line"><a name="l00264"></a><span class="lineno">  264</span>&#160;    <span class="keywordflow">if</span> (use_wproj || use_aproj) {</div><div class="line"><a name="l00265"></a><span class="lineno">  265</span>&#160;        use_wproj = <span class="keyword">true</span>;</div><div class="line"><a name="l00266"></a><span class="lineno">  266</span>&#160;        conv_support = w_proj.max_wpconv_support; <span class="comment">// Set convolution kernel support for gridding</span></div><div class="line"><a name="l00267"></a><span class="lineno">  267</span>&#160;        kernel_exact = <span class="keyword">false</span>; <span class="comment">// kernel exact must be false in this case</span></div><div class="line"><a name="l00268"></a><span class="lineno">  268</span>&#160;    }</div><div class="line"><a name="l00269"></a><span class="lineno">  269</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l00270"></a><span class="lineno">  270</span>&#160;    assert(conv_support &gt; 0);</div><div class="line"><a name="l00271"></a><span class="lineno">  271</span>&#160;</div><div class="line"><a name="l00272"></a><span class="lineno">  272</span>&#160;    <span class="keywordflow">if</span> (kernel_exact == <span class="keyword">true</span>) {</div><div class="line"><a name="l00273"></a><span class="lineno">  273</span>&#160;        oversampling = 1;</div><div class="line"><a name="l00274"></a><span class="lineno">  274</span>&#160;    } <span class="keywordflow">else</span> {</div><div class="line"><a name="l00275"></a><span class="lineno">  275</span>&#160;        oversampling = (oversampling &gt;&gt; 1) &lt;&lt; 1; <span class="comment">// must be multiple of 2</span></div><div class="line"><a name="l00276"></a><span class="lineno">  276</span>&#160;        <span class="keywordflow">if</span> (oversampling == 0)</div><div class="line"><a name="l00277"></a><span class="lineno">  277</span>&#160;            oversampling = 1;</div><div class="line"><a name="l00278"></a><span class="lineno">  278</span>&#160;    }</div><div class="line"><a name="l00279"></a><span class="lineno">  279</span>&#160;</div><div class="line"><a name="l00280"></a><span class="lineno">  280</span>&#160;    arma::uvec good_vis(arma::size(vis));</div><div class="line"><a name="l00281"></a><span class="lineno">  281</span>&#160;    good_vis.ones(); <span class="comment">// Init good_vis with ones</span></div><div class="line"><a name="l00282"></a><span class="lineno">  282</span>&#160;    arma::imat kernel_centre_on_grid(arma::size(uv_lambda));</div><div class="line"><a name="l00283"></a><span class="lineno">  283</span>&#160;    arma::mat uv_frac(arma::size(uv_lambda));</div><div class="line"><a name="l00284"></a><span class="lineno">  284</span>&#160;    arma::vec slha;</div><div class="line"><a name="l00285"></a><span class="lineno">  285</span>&#160;</div><div class="line"><a name="l00286"></a><span class="lineno">  286</span>&#160;<span class="preprocessor">#ifdef WPROJECTION</span></div><div class="line"><a name="l00287"></a><span class="lineno">  287</span>&#160;    <span class="keywordflow">if</span> (use_wproj) {</div><div class="line"><a name="l00291"></a><span class="lineno">  291</span>&#160;        <span class="comment">// create auxiliary vector to keep track of original lambda data</span></div><div class="line"><a name="l00292"></a><span class="lineno">  292</span>&#160;        <span class="comment">// Abs w</span></div><div class="line"><a name="l00293"></a><span class="lineno">  293</span>&#160;        arma::mat uv_aux(arma::size(uv_lambda));</div><div class="line"><a name="l00294"></a><span class="lineno">  294</span>&#160;        arma::mat w_aux(arma::size(w_lambda));</div><div class="line"><a name="l00295"></a><span class="lineno">  295</span>&#160;        arma::cx_mat vis_aux(arma::size(vis));</div><div class="line"><a name="l00296"></a><span class="lineno">  296</span>&#160;        arma::mat vis_weights_aux(arma::size(vis_weights));</div><div class="line"><a name="l00297"></a><span class="lineno">  297</span>&#160;</div><div class="line"><a name="l00298"></a><span class="lineno">  298</span>&#160;        <span class="comment">/***** Sort by the module of w coordinate **/</span></div><div class="line"><a name="l00299"></a><span class="lineno">  299</span>&#160;        arma::uvec sorted_idxs = arma::sort_index(arma::abs(w_lambda), <span class="stringliteral">&quot;ascend&quot;</span>);</div><div class="line"><a name="l00300"></a><span class="lineno">  300</span>&#160;</div><div class="line"><a name="l00301"></a><span class="lineno">  301</span>&#160;        tbb::parallel_for(tbb::blocked_range&lt;size_t&gt;(0, sorted_idxs.n_elem), [&amp;](<span class="keyword">const</span> tbb::blocked_range&lt;size_t&gt;&amp; r) {</div><div class="line"><a name="l00302"></a><span class="lineno">  302</span>&#160;            size_t e = r.end();</div><div class="line"><a name="l00303"></a><span class="lineno">  303</span>&#160;            for (size_t i = r.begin(); i &lt; e; ++i) {</div><div class="line"><a name="l00304"></a><span class="lineno">  304</span>&#160;                uv_aux.at(i, 0) = uv_lambda.at(sorted_idxs[i], 0);</div><div class="line"><a name="l00305"></a><span class="lineno">  305</span>&#160;                uv_aux.at(i, 1) = uv_lambda.at(sorted_idxs[i], 1);</div><div class="line"><a name="l00306"></a><span class="lineno">  306</span>&#160;            }</div><div class="line"><a name="l00307"></a><span class="lineno">  307</span>&#160;        });</div><div class="line"><a name="l00308"></a><span class="lineno">  308</span>&#160;        tbb::parallel_for(tbb::blocked_range&lt;size_t&gt;(0, sorted_idxs.n_elem), [&amp;](<span class="keyword">const</span> tbb::blocked_range&lt;size_t&gt;&amp; r) {</div><div class="line"><a name="l00309"></a><span class="lineno">  309</span>&#160;            size_t e = r.end();</div><div class="line"><a name="l00310"></a><span class="lineno">  310</span>&#160;            for (size_t i = r.begin(); i &lt; e; ++i) {</div><div class="line"><a name="l00311"></a><span class="lineno">  311</span>&#160;                w_aux[i] = w_lambda[sorted_idxs[i]];</div><div class="line"><a name="l00312"></a><span class="lineno">  312</span>&#160;            }</div><div class="line"><a name="l00313"></a><span class="lineno">  313</span>&#160;        });</div><div class="line"><a name="l00314"></a><span class="lineno">  314</span>&#160;        tbb::parallel_for(tbb::blocked_range&lt;size_t&gt;(0, sorted_idxs.n_elem), [&amp;](<span class="keyword">const</span> tbb::blocked_range&lt;size_t&gt;&amp; r) {</div><div class="line"><a name="l00315"></a><span class="lineno">  315</span>&#160;            size_t e = r.end();</div><div class="line"><a name="l00316"></a><span class="lineno">  316</span>&#160;            for (size_t i = r.begin(); i &lt; e; ++i) {</div><div class="line"><a name="l00317"></a><span class="lineno">  317</span>&#160;                vis_aux[i] = vis[sorted_idxs[i]];</div><div class="line"><a name="l00318"></a><span class="lineno">  318</span>&#160;            }</div><div class="line"><a name="l00319"></a><span class="lineno">  319</span>&#160;        });</div><div class="line"><a name="l00320"></a><span class="lineno">  320</span>&#160;        tbb::parallel_for(tbb::blocked_range&lt;size_t&gt;(0, sorted_idxs.n_elem), [&amp;](<span class="keyword">const</span> tbb::blocked_range&lt;size_t&gt;&amp; r) {</div><div class="line"><a name="l00321"></a><span class="lineno">  321</span>&#160;            size_t e = r.end();</div><div class="line"><a name="l00322"></a><span class="lineno">  322</span>&#160;            for (size_t i = r.begin(); i &lt; e; ++i) {</div><div class="line"><a name="l00323"></a><span class="lineno">  323</span>&#160;                vis_weights_aux[i] = vis_weights[sorted_idxs[i]];</div><div class="line"><a name="l00324"></a><span class="lineno">  324</span>&#160;            }</div><div class="line"><a name="l00325"></a><span class="lineno">  325</span>&#160;        });</div><div class="line"><a name="l00326"></a><span class="lineno">  326</span>&#160;</div><div class="line"><a name="l00327"></a><span class="lineno">  327</span>&#160;        <span class="keywordflow">if</span> (use_aproj) {</div><div class="line"><a name="l00328"></a><span class="lineno">  328</span>&#160;            slha.set_size(arma::size(a_proj.lha));</div><div class="line"><a name="l00329"></a><span class="lineno">  329</span>&#160;            tbb::parallel_for(tbb::blocked_range&lt;size_t&gt;(0, sorted_idxs.n_elem), [&amp;](<span class="keyword">const</span> tbb::blocked_range&lt;size_t&gt;&amp; r) {</div><div class="line"><a name="l00330"></a><span class="lineno">  330</span>&#160;                size_t e = r.end();</div><div class="line"><a name="l00331"></a><span class="lineno">  331</span>&#160;                for (size_t i = r.begin(); i &lt; e; ++i) {</div><div class="line"><a name="l00332"></a><span class="lineno">  332</span>&#160;                    slha[i] = a_proj.lha[sorted_idxs[i]];</div><div class="line"><a name="l00333"></a><span class="lineno">  333</span>&#160;                }</div><div class="line"><a name="l00334"></a><span class="lineno">  334</span>&#160;            });</div><div class="line"><a name="l00335"></a><span class="lineno">  335</span>&#160;        }</div><div class="line"><a name="l00336"></a><span class="lineno">  336</span>&#160;</div><div class="line"><a name="l00337"></a><span class="lineno">  337</span>&#160;        uv_lambda = std::move(uv_aux);</div><div class="line"><a name="l00338"></a><span class="lineno">  338</span>&#160;        w_lambda = std::move(w_aux);</div><div class="line"><a name="l00339"></a><span class="lineno">  339</span>&#160;        vis = std::move(vis_aux);</div><div class="line"><a name="l00340"></a><span class="lineno">  340</span>&#160;        vis_weights = std::move(vis_weights_aux);</div><div class="line"><a name="l00341"></a><span class="lineno">  341</span>&#160;    }</div><div class="line"><a name="l00342"></a><span class="lineno">  342</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l00343"></a><span class="lineno">  343</span>&#160;</div><div class="line"><a name="l00344"></a><span class="lineno">  344</span>&#160;    <span class="comment">// If a visibility point is located in the top half-plane, move it to the bottom half-plane to a symmetric position with respect to the matrix centre (0,0)</span></div><div class="line"><a name="l00345"></a><span class="lineno">  345</span>&#160;    <span class="keywordflow">if</span> (halfplane_gridding) {</div><div class="line"><a name="l00346"></a><span class="lineno">  346</span>&#160;        <span class="keywordflow">if</span> (use_wproj)</div><div class="line"><a name="l00347"></a><span class="lineno">  347</span>&#160;            <a class="code" href="namespacestp.html#ad75e5145b07b51b813ec9eaa95e5ac93">convert_to_halfplane_visibilities</a>(uv_lambda, w_lambda, vis, conv_support, good_vis);</div><div class="line"><a name="l00348"></a><span class="lineno">  348</span>&#160;        <span class="keywordflow">else</span></div><div class="line"><a name="l00349"></a><span class="lineno">  349</span>&#160;            <a class="code" href="namespacestp.html#ad75e5145b07b51b813ec9eaa95e5ac93">convert_to_halfplane_visibilities</a>(uv_lambda, vis, conv_support, good_vis);</div><div class="line"><a name="l00350"></a><span class="lineno">  350</span>&#160;    }</div><div class="line"><a name="l00351"></a><span class="lineno">  351</span>&#160;</div><div class="line"><a name="l00352"></a><span class="lineno">  352</span>&#160;    <span class="comment">// get visibilities to be processed and uv_frac</span></div><div class="line"><a name="l00353"></a><span class="lineno">  353</span>&#160;    <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> idx = 0; idx &lt; kernel_centre_on_grid.n_rows; ++idx) {</div><div class="line"><a name="l00354"></a><span class="lineno">  354</span>&#160;        arma::sword val = rint(uv_lambda.at(idx, 0));</div><div class="line"><a name="l00355"></a><span class="lineno">  355</span>&#160;        uv_frac(idx, 0) = uv_lambda.at(idx, 0) - val;</div><div class="line"><a name="l00356"></a><span class="lineno">  356</span>&#160;        kernel_centre_on_grid(idx, 0) = val + half_image_size;</div><div class="line"><a name="l00357"></a><span class="lineno">  357</span>&#160;</div><div class="line"><a name="l00358"></a><span class="lineno">  358</span>&#160;        val = rint(uv_lambda.at(idx, 1));</div><div class="line"><a name="l00359"></a><span class="lineno">  359</span>&#160;        uv_frac(idx, 1) = uv_lambda.at(idx, 1) - val;</div><div class="line"><a name="l00360"></a><span class="lineno">  360</span>&#160;        kernel_centre_on_grid(idx, 1) = val + half_image_size;</div><div class="line"><a name="l00361"></a><span class="lineno">  361</span>&#160;    }</div><div class="line"><a name="l00362"></a><span class="lineno">  362</span>&#160;    <a class="code" href="namespacestp.html#a39093b21b3a22c0e0afcef9127a185f6">bounds_check_kernel_centre_locations</a>(good_vis, kernel_centre_on_grid, image_size, conv_support);</div><div class="line"><a name="l00363"></a><span class="lineno">  363</span>&#160;</div><div class="line"><a name="l00364"></a><span class="lineno">  364</span>&#160;    <a class="code" href="global__macros_8h.html#a360486057265fd50c2351b9b11dab52b">STPLIB_DEBUG</a>(spdlog::get(<span class="stringliteral">&quot;stplib&quot;</span>), <span class="stringliteral">&quot;Gridder: Total # of vis = {}&quot;</span>, vis.n_elem);</div><div class="line"><a name="l00365"></a><span class="lineno">  365</span>&#160;    <a class="code" href="global__macros_8h.html#a360486057265fd50c2351b9b11dab52b">STPLIB_DEBUG</a>(spdlog::get(<span class="stringliteral">&quot;stplib&quot;</span>), <span class="stringliteral">&quot;Gridder: Total # of good vis = {}&quot;</span>, arma::accu(good_vis != 0));</div><div class="line"><a name="l00366"></a><span class="lineno">  366</span>&#160;</div><div class="line"><a name="l00367"></a><span class="lineno">  367</span>&#160;    <span class="comment">// Number of rows of the output images. This changes if halfplane gridding is used</span></div><div class="line"><a name="l00368"></a><span class="lineno">  368</span>&#160;    <span class="keywordtype">int</span> image_rows = image_size;</div><div class="line"><a name="l00369"></a><span class="lineno">  369</span>&#160;    <span class="keywordflow">if</span> (halfplane_gridding) {</div><div class="line"><a name="l00370"></a><span class="lineno">  370</span>&#160;        image_rows = half_image_size + 1;</div><div class="line"><a name="l00371"></a><span class="lineno">  371</span>&#160;    }</div><div class="line"><a name="l00372"></a><span class="lineno">  372</span>&#160;</div><div class="line"><a name="l00373"></a><span class="lineno">  373</span>&#160;    <span class="comment">// Shift positions of the visibilities (to avoid call to fftshift function)</span></div><div class="line"><a name="l00374"></a><span class="lineno">  374</span>&#160;    <span class="keywordflow">if</span> (shift_uv) {</div><div class="line"><a name="l00375"></a><span class="lineno">  375</span>&#160;        <span class="keywordtype">int</span> shift_offset = half_image_size;</div><div class="line"><a name="l00376"></a><span class="lineno">  376</span>&#160;        kernel_centre_on_grid.each_row([&amp;](arma::imat&amp; r) {</div><div class="line"><a name="l00377"></a><span class="lineno">  377</span>&#160;            <span class="keywordflow">if</span> (r[0] &lt; shift_offset) {</div><div class="line"><a name="l00378"></a><span class="lineno">  378</span>&#160;                r[0] += shift_offset;</div><div class="line"><a name="l00379"></a><span class="lineno">  379</span>&#160;            } <span class="keywordflow">else</span> {</div><div class="line"><a name="l00380"></a><span class="lineno">  380</span>&#160;                r[0] -= shift_offset;</div><div class="line"><a name="l00381"></a><span class="lineno">  381</span>&#160;            }</div><div class="line"><a name="l00382"></a><span class="lineno">  382</span>&#160;            <span class="keywordflow">if</span> (r[1] &lt; shift_offset) {</div><div class="line"><a name="l00383"></a><span class="lineno">  383</span>&#160;                r[1] += shift_offset;</div><div class="line"><a name="l00384"></a><span class="lineno">  384</span>&#160;            } <span class="keywordflow">else</span> {</div><div class="line"><a name="l00385"></a><span class="lineno">  385</span>&#160;                r[1] -= shift_offset;</div><div class="line"><a name="l00386"></a><span class="lineno">  386</span>&#160;            }</div><div class="line"><a name="l00387"></a><span class="lineno">  387</span>&#160;        });</div><div class="line"><a name="l00388"></a><span class="lineno">  388</span>&#160;    }</div><div class="line"><a name="l00389"></a><span class="lineno">  389</span>&#160;</div><div class="line"><a name="l00390"></a><span class="lineno">  390</span>&#160;    <span class="comment">// Compute total sampling grid</span></div><div class="line"><a name="l00391"></a><span class="lineno">  391</span>&#160;    <span class="comment">// Used to renormalize the visibilities by the sampled weights total</span></div><div class="line"><a name="l00392"></a><span class="lineno">  392</span>&#160;    <span class="keywordtype">double</span> sample_grid_total = 0;</div><div class="line"><a name="l00393"></a><span class="lineno">  393</span>&#160;    <span class="keywordflow">for</span> (arma::uword vi = 0; vi &lt; good_vis.n_elem; vi++) {</div><div class="line"><a name="l00394"></a><span class="lineno">  394</span>&#160;        <span class="keywordflow">if</span> (good_vis[vi] != 0)</div><div class="line"><a name="l00395"></a><span class="lineno">  395</span>&#160;            sample_grid_total += vis_weights[vi];</div><div class="line"><a name="l00396"></a><span class="lineno">  396</span>&#160;    }</div><div class="line"><a name="l00397"></a><span class="lineno">  397</span>&#160;    <span class="comment">// Total sampling grid value must be doubled because we are using half gridder image</span></div><div class="line"><a name="l00398"></a><span class="lineno">  398</span>&#160;    sample_grid_total *= 2.0;</div><div class="line"><a name="l00399"></a><span class="lineno">  399</span>&#160;</div><div class="line"><a name="l00400"></a><span class="lineno">  400</span>&#160;    <span class="comment">// Create matrices for output gridded images</span></div><div class="line"><a name="l00401"></a><span class="lineno">  401</span>&#160;    <span class="comment">// Use MatStp class because these images shall be efficiently initialized with zeros</span></div><div class="line"><a name="l00402"></a><span class="lineno">  402</span>&#160;    MatStp&lt;cx_real_t&gt; vis_grid(image_rows, image_size);</div><div class="line"><a name="l00403"></a><span class="lineno">  403</span>&#160;    <span class="keywordtype">int</span> sampl_image_size = 0;</div><div class="line"><a name="l00404"></a><span class="lineno">  404</span>&#160;    <span class="keywordtype">int</span> sampl_image_rows = 0;</div><div class="line"><a name="l00405"></a><span class="lineno">  405</span>&#160;    <span class="keywordflow">if</span> (generateBeam) {</div><div class="line"><a name="l00406"></a><span class="lineno">  406</span>&#160;        sampl_image_size = image_size;</div><div class="line"><a name="l00407"></a><span class="lineno">  407</span>&#160;        sampl_image_rows = image_rows;</div><div class="line"><a name="l00408"></a><span class="lineno">  408</span>&#160;    }</div><div class="line"><a name="l00409"></a><span class="lineno">  409</span>&#160;</div><div class="line"><a name="l00410"></a><span class="lineno">  410</span>&#160;    MatStp&lt;cx_real_t&gt; sampling_grid(sampl_image_rows, sampl_image_size);</div><div class="line"><a name="l00411"></a><span class="lineno">  411</span>&#160;    <span class="keywordtype">int</span> kernel_size = conv_support * 2 + 1;</div><div class="line"><a name="l00412"></a><span class="lineno">  412</span>&#160;</div><div class="line"><a name="l00413"></a><span class="lineno">  413</span>&#160;    <span class="keywordflow">if</span> (kernel_exact == <span class="keyword">false</span>) {</div><div class="line"><a name="l00414"></a><span class="lineno">  414</span>&#160;        <span class="comment">// kernel caches declaration</span></div><div class="line"><a name="l00415"></a><span class="lineno">  415</span>&#160;        arma::field&lt;arma::Mat&lt;cx_real_t&gt;&gt; kernel_cache;</div><div class="line"><a name="l00416"></a><span class="lineno">  416</span>&#160;        <span class="comment">// kernel fft</span></div><div class="line"><a name="l00417"></a><span class="lineno">  417</span>&#160;        arma::Col&lt;real_t&gt; aa_kernel_img;</div><div class="line"><a name="l00418"></a><span class="lineno">  418</span>&#160;</div><div class="line"><a name="l00419"></a><span class="lineno">  419</span>&#160;<span class="preprocessor">#ifdef WPROJECTION</span></div><div class="line"><a name="l00420"></a><span class="lineno">  420</span>&#160;        <span class="comment">// aux vars</span></div><div class="line"><a name="l00421"></a><span class="lineno">  421</span>&#160;        <span class="keywordtype">int</span> undersampling_ratio = 1;</div><div class="line"><a name="l00422"></a><span class="lineno">  422</span>&#160;        <span class="keywordtype">int</span> workarea_size = image_size;</div><div class="line"><a name="l00423"></a><span class="lineno">  423</span>&#160;</div><div class="line"><a name="l00424"></a><span class="lineno">  424</span>&#160;        <span class="comment">// local data</span></div><div class="line"><a name="l00425"></a><span class="lineno">  425</span>&#160;        arma::vec w_avg_values; <span class="comment">// vector of w_planes</span></div><div class="line"><a name="l00426"></a><span class="lineno">  426</span>&#160;        arma::ivec w_planes_firstidx; <span class="comment">// wplanes index tracking</span></div><div class="line"><a name="l00427"></a><span class="lineno">  427</span>&#160;</div><div class="line"><a name="l00428"></a><span class="lineno">  428</span>&#160;        <span class="comment">// Compute W-Planes and convolution kernels for W-Projection</span></div><div class="line"><a name="l00429"></a><span class="lineno">  429</span>&#160;        <span class="keywordtype">int</span> num_wplanes = 1;</div><div class="line"><a name="l00430"></a><span class="lineno">  430</span>&#160;        <span class="keywordflow">if</span> (use_wproj) {</div><div class="line"><a name="l00431"></a><span class="lineno">  431</span>&#160;            num_wplanes = w_proj.num_wplanes;</div><div class="line"><a name="l00432"></a><span class="lineno">  432</span>&#160;</div><div class="line"><a name="l00433"></a><span class="lineno">  433</span>&#160;            <span class="comment">// create w plane array and idx tracker</span></div><div class="line"><a name="l00434"></a><span class="lineno">  434</span>&#160;            w_avg_values.set_size(num_wplanes);</div><div class="line"><a name="l00435"></a><span class="lineno">  435</span>&#160;            w_planes_firstidx.set_size(num_wplanes);</div><div class="line"><a name="l00436"></a><span class="lineno">  436</span>&#160;</div><div class="line"><a name="l00437"></a><span class="lineno">  437</span>&#160;            <span class="comment">// calculate w_planes_avg</span></div><div class="line"><a name="l00438"></a><span class="lineno">  438</span>&#160;            <a class="code" href="namespacestp.html#ac088200d449ac7f780530a45d80f9775">average_w_planes</a>(arma::abs(w_lambda), good_vis, num_wplanes, w_avg_values, w_planes_firstidx, w_proj.wplanes_median);</div><div class="line"><a name="l00439"></a><span class="lineno">  439</span>&#160;</div><div class="line"><a name="l00440"></a><span class="lineno">  440</span>&#160;            <span class="comment">/*** Calculate kernel working area size */</span></div><div class="line"><a name="l00441"></a><span class="lineno">  441</span>&#160;            <span class="keywordtype">int</span> undersampling_opt = w_proj.undersampling_opt &gt; 0 ? std::pow(2, w_proj.undersampling_opt - 1) : 0;</div><div class="line"><a name="l00442"></a><span class="lineno">  442</span>&#160;            <span class="keywordflow">if</span> (undersampling_opt &gt; 0) {</div><div class="line"><a name="l00443"></a><span class="lineno">  443</span>&#160;                <span class="keywordflow">while</span> ((image_size / (undersampling_ratio * 2 * undersampling_opt)) &gt; (conv_support * 2 + 1)) {</div><div class="line"><a name="l00444"></a><span class="lineno">  444</span>&#160;                    undersampling_ratio *= 2;</div><div class="line"><a name="l00445"></a><span class="lineno">  445</span>&#160;                }</div><div class="line"><a name="l00446"></a><span class="lineno">  446</span>&#160;                workarea_size = image_size / undersampling_ratio;</div><div class="line"><a name="l00447"></a><span class="lineno">  447</span>&#160;            }</div><div class="line"><a name="l00448"></a><span class="lineno">  448</span>&#160;</div><div class="line"><a name="l00449"></a><span class="lineno">  449</span>&#160;            <span class="keywordflow">if</span> (w_proj.hankel_opt == <span class="keyword">true</span>) {</div><div class="line"><a name="l00450"></a><span class="lineno">  450</span>&#160;                <span class="keywordflow">if</span> (undersampling_ratio &gt; 1) {</div><div class="line"><a name="l00451"></a><span class="lineno">  451</span>&#160;                    undersampling_ratio = undersampling_ratio / 2;</div><div class="line"><a name="l00452"></a><span class="lineno">  452</span>&#160;                    workarea_size = workarea_size * 2;</div><div class="line"><a name="l00453"></a><span class="lineno">  453</span>&#160;                }</div><div class="line"><a name="l00454"></a><span class="lineno">  454</span>&#160;            }</div><div class="line"><a name="l00455"></a><span class="lineno">  455</span>&#160;</div><div class="line"><a name="l00456"></a><span class="lineno">  456</span>&#160;            aa_kernel_img = <a class="code" href="namespacestp.html#a404fa9ce3a8e0427915ba3ac3aea9a16">ImgDomKernel</a>(kernel_creator, workarea_size, <span class="keyword">false</span>, analytic_gcf, r_fft);</div><div class="line"><a name="l00457"></a><span class="lineno">  457</span>&#160;        } <span class="keywordflow">else</span> {</div><div class="line"><a name="l00458"></a><span class="lineno">  458</span>&#160;            <span class="comment">// Set some variables when w-projection is not used</span></div><div class="line"><a name="l00459"></a><span class="lineno">  459</span>&#160;            num_wplanes = 1;</div><div class="line"><a name="l00460"></a><span class="lineno">  460</span>&#160;            w_planes_firstidx.set_size(1);</div><div class="line"><a name="l00461"></a><span class="lineno">  461</span>&#160;            w_planes_firstidx(0) = 0;</div><div class="line"><a name="l00462"></a><span class="lineno">  462</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l00463"></a><span class="lineno">  463</span>&#160;            kernel_cache = <a class="code" href="namespacestp.html#a19e8b064e439617289907aeed2c00c76">populate_kernel_cache</a>(kernel_creator, support, oversampling, <span class="comment">/*pad*/</span> <span class="keyword">false</span>, <span class="comment">/*normalize*/</span> <span class="keyword">true</span>);</div><div class="line"><a name="l00464"></a><span class="lineno">  464</span>&#160;<span class="preprocessor">#ifdef WPROJECTION</span></div><div class="line"><a name="l00465"></a><span class="lineno">  465</span>&#160;        }</div><div class="line"><a name="l00466"></a><span class="lineno">  466</span>&#160;</div><div class="line"><a name="l00467"></a><span class="lineno">  467</span>&#160;        <span class="comment">// Create W-kernel object</span></div><div class="line"><a name="l00468"></a><span class="lineno">  468</span>&#160;        WideFieldImaging wide_imaging(workarea_size, <a class="code" href="gridder_8h.html#ad560e7fb8564c991d39374775a382e80">arc_sec_to_rad</a>(cell_size), oversampling, undersampling_ratio, w_proj, r_fft);</div><div class="line"><a name="l00469"></a><span class="lineno">  469</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l00470"></a><span class="lineno">  470</span>&#160;</div><div class="line"><a name="l00471"></a><span class="lineno">  471</span>&#160;        <span class="comment">// get oversampled kernel indexes</span></div><div class="line"><a name="l00472"></a><span class="lineno">  472</span>&#160;        arma::imat oversampled_offset = <a class="code" href="namespacestp.html#ad2191add2b4abbc6ff7cb8c4102097ca">calculate_oversampled_kernel_indices</a>(uv_frac, oversampling) + (oversampling / 2);</div><div class="line"><a name="l00473"></a><span class="lineno">  473</span>&#160;</div><div class="line"><a name="l00474"></a><span class="lineno">  474</span>&#160;<span class="preprocessor">#ifdef APROJECTION</span></div><div class="line"><a name="l00475"></a><span class="lineno">  475</span>&#160;        arma::ivec vis_timesteps(arma::size(vis));</div><div class="line"><a name="l00476"></a><span class="lineno">  476</span>&#160;        arma::vec lha_mean;</div><div class="line"><a name="l00477"></a><span class="lineno">  477</span>&#160;        <span class="keywordtype">int</span> num_timesteps = 1;</div><div class="line"><a name="l00478"></a><span class="lineno">  478</span>&#160;        <span class="keywordflow">if</span> (use_aproj) {</div><div class="line"><a name="l00479"></a><span class="lineno">  479</span>&#160;            <span class="comment">// Find maximum and minimum lha values</span></div><div class="line"><a name="l00480"></a><span class="lineno">  480</span>&#160;            <span class="keywordtype">double</span> min_time = slha[0];</div><div class="line"><a name="l00481"></a><span class="lineno">  481</span>&#160;            <span class="keywordtype">double</span> max_time = slha[0];</div><div class="line"><a name="l00482"></a><span class="lineno">  482</span>&#160;            slha.for_each([&amp;](arma::mat::elem_type&amp; val) {</div><div class="line"><a name="l00483"></a><span class="lineno">  483</span>&#160;                <span class="keywordflow">if</span> (val &lt; min_time) {</div><div class="line"><a name="l00484"></a><span class="lineno">  484</span>&#160;                    min_time = val;</div><div class="line"><a name="l00485"></a><span class="lineno">  485</span>&#160;                }</div><div class="line"><a name="l00486"></a><span class="lineno">  486</span>&#160;                <span class="keywordflow">if</span> (val &gt; max_time) {</div><div class="line"><a name="l00487"></a><span class="lineno">  487</span>&#160;                    max_time = val;</div><div class="line"><a name="l00488"></a><span class="lineno">  488</span>&#160;                }</div><div class="line"><a name="l00489"></a><span class="lineno">  489</span>&#160;            });</div><div class="line"><a name="l00490"></a><span class="lineno">  490</span>&#160;</div><div class="line"><a name="l00491"></a><span class="lineno">  491</span>&#160;            <span class="comment">// Define time intervals</span></div><div class="line"><a name="l00492"></a><span class="lineno">  492</span>&#160;            num_timesteps = a_proj.num_timesteps;</div><div class="line"><a name="l00493"></a><span class="lineno">  493</span>&#160;            <span class="keywordtype">double</span> tstep_size = (max_time - min_time) / num_timesteps;</div><div class="line"><a name="l00494"></a><span class="lineno">  494</span>&#160;            arma::vec time_intervals = arma::linspace(min_time - tstep_size / 2, max_time + tstep_size / 2, num_timesteps + 1);</div><div class="line"><a name="l00495"></a><span class="lineno">  495</span>&#160;            arma::uvec nvis_tstep_aux = arma::zeros&lt;arma::uvec&gt;(num_timesteps);</div><div class="line"><a name="l00496"></a><span class="lineno">  496</span>&#160;            lha_mean = arma::zeros(num_timesteps);</div><div class="line"><a name="l00497"></a><span class="lineno">  497</span>&#160;</div><div class="line"><a name="l00498"></a><span class="lineno">  498</span>&#160;            <span class="comment">// Assign each visibility to a time interval</span></div><div class="line"><a name="l00499"></a><span class="lineno">  499</span>&#160;            <span class="keywordflow">for</span> (arma::uword i = 0; i &lt; slha.n_elem; i++) {</div><div class="line"><a name="l00500"></a><span class="lineno">  500</span>&#160;                <span class="keywordflow">if</span> (!good_vis[i])</div><div class="line"><a name="l00501"></a><span class="lineno">  501</span>&#160;                    <span class="keywordflow">continue</span>;</div><div class="line"><a name="l00502"></a><span class="lineno">  502</span>&#160;</div><div class="line"><a name="l00503"></a><span class="lineno">  503</span>&#160;                <span class="keywordtype">double</span> time_value = slha.at(i);</div><div class="line"><a name="l00504"></a><span class="lineno">  504</span>&#160;                <span class="keywordtype">int</span> tidx = 1;</div><div class="line"><a name="l00505"></a><span class="lineno">  505</span>&#160;                <span class="keywordtype">double</span> interval_value = time_intervals.at(tidx);</div><div class="line"><a name="l00506"></a><span class="lineno">  506</span>&#160;                <span class="keywordflow">while</span> (time_value &gt; interval_value) {</div><div class="line"><a name="l00507"></a><span class="lineno">  507</span>&#160;                    tidx++;</div><div class="line"><a name="l00508"></a><span class="lineno">  508</span>&#160;                    <span class="keywordflow">if</span> (tidx &lt; (num_timesteps + 1)) {</div><div class="line"><a name="l00509"></a><span class="lineno">  509</span>&#160;                        interval_value = time_intervals.at(tidx);</div><div class="line"><a name="l00510"></a><span class="lineno">  510</span>&#160;                    } <span class="keywordflow">else</span> {</div><div class="line"><a name="l00511"></a><span class="lineno">  511</span>&#160;                        <span class="keywordflow">break</span>;</div><div class="line"><a name="l00512"></a><span class="lineno">  512</span>&#160;                    }</div><div class="line"><a name="l00513"></a><span class="lineno">  513</span>&#160;                }</div><div class="line"><a name="l00514"></a><span class="lineno">  514</span>&#160;                <span class="comment">// Selected time step</span></div><div class="line"><a name="l00515"></a><span class="lineno">  515</span>&#160;                <span class="keywordtype">int</span> seltimestep_idx = tidx - 1;</div><div class="line"><a name="l00516"></a><span class="lineno">  516</span>&#160;                assert(seltimestep_idx &gt;= 0);</div><div class="line"><a name="l00517"></a><span class="lineno">  517</span>&#160;                assert(seltimestep_idx &lt; num_timesteps);</div><div class="line"><a name="l00518"></a><span class="lineno">  518</span>&#160;                vis_timesteps[i] = seltimestep_idx;</div><div class="line"><a name="l00519"></a><span class="lineno">  519</span>&#160;                <span class="comment">// Auxiliary calcs for mean computation</span></div><div class="line"><a name="l00520"></a><span class="lineno">  520</span>&#160;                lha_mean.at(seltimestep_idx) += time_value;</div><div class="line"><a name="l00521"></a><span class="lineno">  521</span>&#160;                nvis_tstep_aux.at(seltimestep_idx)++;</div><div class="line"><a name="l00522"></a><span class="lineno">  522</span>&#160;            }</div><div class="line"><a name="l00523"></a><span class="lineno">  523</span>&#160;            <span class="comment">// Compute mean values</span></div><div class="line"><a name="l00524"></a><span class="lineno">  524</span>&#160;            <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; num_timesteps; i++) {</div><div class="line"><a name="l00525"></a><span class="lineno">  525</span>&#160;                <span class="keywordflow">if</span> (nvis_tstep_aux.at(i)) {</div><div class="line"><a name="l00526"></a><span class="lineno">  526</span>&#160;                    lha_mean.at(i) /= nvis_tstep_aux.at(i);</div><div class="line"><a name="l00527"></a><span class="lineno">  527</span>&#160;                } <span class="keywordflow">else</span> {</div><div class="line"><a name="l00528"></a><span class="lineno">  528</span>&#160;                    lha_mean.at(i) = 0.0;</div><div class="line"><a name="l00529"></a><span class="lineno">  529</span>&#160;                }</div><div class="line"><a name="l00530"></a><span class="lineno">  530</span>&#160;            }</div><div class="line"><a name="l00531"></a><span class="lineno">  531</span>&#160;        }</div><div class="line"><a name="l00532"></a><span class="lineno">  532</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l00533"></a><span class="lineno">  533</span>&#160;</div><div class="line"><a name="l00534"></a><span class="lineno">  534</span>&#160;        <a class="code" href="global__macros_8h.html#acd403c01031d455af6f542e322f9a7b3">TIMESTAMP_IMAGER</a></div><div class="line"><a name="l00535"></a><span class="lineno">  535</span>&#160;</div><div class="line"><a name="l00536"></a><span class="lineno">  536</span>&#160;<span class="preprocessor">#ifdef SERIAL_GRIDDER</span></div><div class="line"><a name="l00537"></a><span class="lineno">  537</span>&#160;        <span class="comment">// Single-threaded implementation of oversampled gridder</span></div><div class="line"><a name="l00538"></a><span class="lineno">  538</span>&#160;<span class="preprocessor">#ifdef WPROJECTION</span></div><div class="line"><a name="l00539"></a><span class="lineno">  539</span>&#160;        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> pi = 0; pi &lt; num_wplanes; pi++) {</div><div class="line"><a name="l00540"></a><span class="lineno">  540</span>&#160;            arma::field&lt;arma::Mat&lt;cx_real_t&gt;&gt; kernel_cache_conj;</div><div class="line"><a name="l00541"></a><span class="lineno">  541</span>&#160;            arma::uword vi_begin = w_planes_firstidx(pi);</div><div class="line"><a name="l00542"></a><span class="lineno">  542</span>&#160;            arma::uword vi_end = (pi == (num_wplanes - 1)) ? good_vis.n_elem : w_planes_firstidx(pi + 1);</div><div class="line"><a name="l00543"></a><span class="lineno">  543</span>&#160;<span class="preprocessor">#else</span></div><div class="line"><a name="l00544"></a><span class="lineno">  544</span>&#160;        arma::uword vi_begin = 0;</div><div class="line"><a name="l00545"></a><span class="lineno">  545</span>&#160;        arma::uword vi_end = good_vis.n_elem;</div><div class="line"><a name="l00546"></a><span class="lineno">  546</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l00547"></a><span class="lineno">  547</span>&#160;<span class="preprocessor">#ifdef WPROJECTION</span></div><div class="line"><a name="l00548"></a><span class="lineno">  548</span>&#160;            <span class="keywordflow">if</span> (use_wproj) {</div><div class="line"><a name="l00549"></a><span class="lineno">  549</span>&#160;                <span class="keywordflow">if</span> (use_aproj) {</div><div class="line"><a name="l00550"></a><span class="lineno">  550</span>&#160;                    <span class="comment">// Generate new AA/W-kernel for A-projection</span></div><div class="line"><a name="l00551"></a><span class="lineno">  551</span>&#160;                    wide_imaging.generate_combined_w_aa_kernel(w_avg_values(pi), aa_kernel_img);</div><div class="line"><a name="l00552"></a><span class="lineno">  552</span>&#160;                } <span class="keywordflow">else</span> {</div><div class="line"><a name="l00553"></a><span class="lineno">  553</span>&#160;                    <span class="comment">// Generate new convolution kernel for W-projection</span></div><div class="line"><a name="l00554"></a><span class="lineno">  554</span>&#160;                    wide_imaging.generate_convolution_kernel_wproj(w_avg_values(pi), aa_kernel_img);</div><div class="line"><a name="l00555"></a><span class="lineno">  555</span>&#160;                }</div><div class="line"><a name="l00556"></a><span class="lineno">  556</span>&#160;            }</div><div class="line"><a name="l00557"></a><span class="lineno">  557</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l00558"></a><span class="lineno">  558</span>&#160;<span class="preprocessor">#ifdef APROJECTION</span></div><div class="line"><a name="l00559"></a><span class="lineno">  559</span>&#160;            <span class="keywordflow">for</span> (<span class="keywordtype">int</span> ts = 0; ts &lt; num_timesteps; ts++) {</div><div class="line"><a name="l00560"></a><span class="lineno">  560</span>&#160;                <span class="keywordflow">if</span> (use_aproj) {</div><div class="line"><a name="l00561"></a><span class="lineno">  561</span>&#160;                    <span class="comment">// Generate the AW - kernels</span></div><div class="line"><a name="l00562"></a><span class="lineno">  562</span>&#160;                    <span class="keywordtype">double</span> pangle = <a class="code" href="namespacestp.html#a723e08fc37f8606211f7abbda740d4e1">parangle</a>(lha_mean.at(ts), a_proj.obs_dec, a_proj.obs_lat);</div><div class="line"><a name="l00563"></a><span class="lineno">  563</span>&#160;                    <span class="keywordtype">double</span> pbmin = a_proj.mueller_term(0, 0);</div><div class="line"><a name="l00564"></a><span class="lineno">  564</span>&#160;                    arma::Mat&lt;real_t&gt; a_kernel = <a class="code" href="namespacestp.html#acd1a18f626d11eebaae47da542f454d1">rotate_matrix</a>(a_proj.mueller_term, pangle, pbmin, workarea_size);</div><div class="line"><a name="l00565"></a><span class="lineno">  565</span>&#160;                    <span class="comment">// Generate new convolution kernel for A-projection</span></div><div class="line"><a name="l00566"></a><span class="lineno">  566</span>&#160;                    wide_imaging.generate_convolution_kernel_aproj(a_kernel);</div><div class="line"><a name="l00567"></a><span class="lineno">  567</span>&#160;                }</div><div class="line"><a name="l00568"></a><span class="lineno">  568</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l00569"></a><span class="lineno">  569</span>&#160;<span class="preprocessor">#ifdef WPROJECTION</span></div><div class="line"><a name="l00570"></a><span class="lineno">  570</span>&#160;                <span class="keywordflow">if</span> (use_wproj) {</div><div class="line"><a name="l00571"></a><span class="lineno">  571</span>&#160;                    kernel_cache = wide_imaging.generate_kernel_cache();</div><div class="line"><a name="l00572"></a><span class="lineno">  572</span>&#160;                    conv_support = wide_imaging.get_trunc_conv_support();</div><div class="line"><a name="l00573"></a><span class="lineno">  573</span>&#160;                    assert(conv_support &gt; 0);</div><div class="line"><a name="l00574"></a><span class="lineno">  574</span>&#160;                    kernel_size = conv_support * 2 + 1;</div><div class="line"><a name="l00575"></a><span class="lineno">  575</span>&#160;                    kernel_cache_conj.reset();</div><div class="line"><a name="l00576"></a><span class="lineno">  576</span>&#160;                    kernel_cache_conj.set_size(arma::size(kernel_cache));</div><div class="line"><a name="l00577"></a><span class="lineno">  577</span>&#160;                }</div><div class="line"><a name="l00578"></a><span class="lineno">  578</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l00579"></a><span class="lineno">  579</span>&#160;                <span class="keywordflow">for</span> (arma::uword vi = vi_begin; vi &lt; vi_end; vi++) {</div><div class="line"><a name="l00580"></a><span class="lineno">  580</span>&#160;                    <span class="keyword">const</span> uint good_vis_val = good_vis[vi];</div><div class="line"><a name="l00581"></a><span class="lineno">  581</span>&#160;</div><div class="line"><a name="l00582"></a><span class="lineno">  582</span>&#160;<span class="preprocessor">#ifdef APROJECTION</span></div><div class="line"><a name="l00583"></a><span class="lineno">  583</span>&#160;                    <span class="comment">// Skip this visibility if using A-projection and it does not belong to the time interval</span></div><div class="line"><a name="l00584"></a><span class="lineno">  584</span>&#160;                    <span class="keywordflow">if</span> (use_aproj)</div><div class="line"><a name="l00585"></a><span class="lineno">  585</span>&#160;                        <span class="keywordflow">if</span> (vis_timesteps[vi] != ts)</div><div class="line"><a name="l00586"></a><span class="lineno">  586</span>&#160;                            <span class="keywordflow">continue</span>;</div><div class="line"><a name="l00587"></a><span class="lineno">  587</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l00588"></a><span class="lineno">  588</span>&#160;                    <span class="keywordflow">if</span> (good_vis_val == 0)</div><div class="line"><a name="l00589"></a><span class="lineno">  589</span>&#160;                        <span class="keywordflow">continue</span>;</div><div class="line"><a name="l00590"></a><span class="lineno">  590</span>&#160;</div><div class="line"><a name="l00591"></a><span class="lineno">  591</span>&#160;                    <span class="keywordtype">int</span> gc_x = kernel_centre_on_grid(vi, 0);</div><div class="line"><a name="l00592"></a><span class="lineno">  592</span>&#160;                    <span class="keywordtype">int</span> gc_y = kernel_centre_on_grid(vi, 1);</div><div class="line"><a name="l00593"></a><span class="lineno">  593</span>&#160;                    uint cp_x = oversampled_offset.at(vi, 0);</div><div class="line"><a name="l00594"></a><span class="lineno">  594</span>&#160;                    uint cp_y = oversampled_offset.at(vi, 1);</div><div class="line"><a name="l00595"></a><span class="lineno">  595</span>&#160;                    <a class="code" href="types_8h.html#a1d2a57e59f061705d305d324a80d4ca1">cx_real_t</a> vis_val = <a class="code" href="types_8h.html#a1d2a57e59f061705d305d324a80d4ca1">cx_real_t</a>(vis[vi]);</div><div class="line"><a name="l00596"></a><span class="lineno">  596</span>&#160;                    <span class="keyword">const</span> <a class="code" href="types_8h.html#ab46614359717672dc9a4eed4669be6e6">real_t</a> vis_weight = vis_weights[vi];</div><div class="line"><a name="l00597"></a><span class="lineno">  597</span>&#160;<span class="preprocessor">#ifdef WPROJECTION</span></div><div class="line"><a name="l00598"></a><span class="lineno">  598</span>&#160;                    <span class="keywordtype">double</span> w_lambda_val = w_lambda.at(vi);</div><div class="line"><a name="l00599"></a><span class="lineno">  599</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l00600"></a><span class="lineno">  600</span>&#160;</div><div class="line"><a name="l00601"></a><span class="lineno">  601</span>&#160;                    <span class="comment">// If good_vis[vi] is 2, add also conjugate visibility</span></div><div class="line"><a name="l00602"></a><span class="lineno">  602</span>&#160;                    <span class="keywordflow">for</span> (uint gv = 0; gv &lt; good_vis_val; gv++) {</div><div class="line"><a name="l00603"></a><span class="lineno">  603</span>&#160;</div><div class="line"><a name="l00604"></a><span class="lineno">  604</span>&#160;                        <span class="keywordflow">if</span> (gv) {</div><div class="line"><a name="l00605"></a><span class="lineno">  605</span>&#160;                            gc_x = -kernel_centre_on_grid(vi, 0) + image_size;</div><div class="line"><a name="l00606"></a><span class="lineno">  606</span>&#160;                            gc_y = -kernel_centre_on_grid(vi, 1) + image_size;</div><div class="line"><a name="l00607"></a><span class="lineno">  607</span>&#160;                            <span class="keywordflow">if</span> (oversampling &gt; 1) {</div><div class="line"><a name="l00608"></a><span class="lineno">  608</span>&#160;                                cp_x = -oversampled_offset.at(vi, 0) + oversampling;</div><div class="line"><a name="l00609"></a><span class="lineno">  609</span>&#160;                                cp_y = -oversampled_offset.at(vi, 1) + oversampling;</div><div class="line"><a name="l00610"></a><span class="lineno">  610</span>&#160;                            }</div><div class="line"><a name="l00611"></a><span class="lineno">  611</span>&#160;                            vis_val = std::conj(vis_val);</div><div class="line"><a name="l00612"></a><span class="lineno">  612</span>&#160;<span class="preprocessor">#ifdef WPROJECTION</span></div><div class="line"><a name="l00613"></a><span class="lineno">  613</span>&#160;                            w_lambda_val *= (-1);</div><div class="line"><a name="l00614"></a><span class="lineno">  614</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l00615"></a><span class="lineno">  615</span>&#160;                        }</div><div class="line"><a name="l00616"></a><span class="lineno">  616</span>&#160;</div><div class="line"><a name="l00617"></a><span class="lineno">  617</span>&#160;                        arma::Mat&lt;cx_real_t&gt;* conv_kernel_array = &amp;(kernel_cache(cp_y, cp_x));</div><div class="line"><a name="l00618"></a><span class="lineno">  618</span>&#160;<span class="preprocessor">#ifdef WPROJECTION</span></div><div class="line"><a name="l00619"></a><span class="lineno">  619</span>&#160;                        <span class="keywordflow">if</span> (use_wproj) {</div><div class="line"><a name="l00620"></a><span class="lineno">  620</span>&#160;                            <span class="keywordflow">if</span> (w_lambda_val &lt; 0.0) {</div><div class="line"><a name="l00621"></a><span class="lineno">  621</span>&#160;                                <span class="keywordflow">if</span> (kernel_cache_conj(cp_y, cp_x).is_empty()) {</div><div class="line"><a name="l00622"></a><span class="lineno">  622</span>&#160;                                    kernel_cache_conj(cp_y, cp_x) = std::move(arma::conj(kernel_cache(cp_y, cp_x)));</div><div class="line"><a name="l00623"></a><span class="lineno">  623</span>&#160;                                }</div><div class="line"><a name="l00624"></a><span class="lineno">  624</span>&#160;                                conv_kernel_array = &amp;(kernel_cache_conj(cp_y, cp_x));</div><div class="line"><a name="l00625"></a><span class="lineno">  625</span>&#160;                            }</div><div class="line"><a name="l00626"></a><span class="lineno">  626</span>&#160;                        }</div><div class="line"><a name="l00627"></a><span class="lineno">  627</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l00628"></a><span class="lineno">  628</span>&#160;                        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j = 0; j &lt; kernel_size; j++) {</div><div class="line"><a name="l00629"></a><span class="lineno">  629</span>&#160;                            <span class="keywordtype">int</span> grid_col = gc_x - conv_support + j;</div><div class="line"><a name="l00630"></a><span class="lineno">  630</span>&#160;                            <span class="keywordflow">if</span> (grid_col &lt; 0) <span class="comment">// left/right split of the kernel</span></div><div class="line"><a name="l00631"></a><span class="lineno">  631</span>&#160;                                grid_col += image_size;</div><div class="line"><a name="l00632"></a><span class="lineno">  632</span>&#160;                            <span class="keywordflow">if</span> (grid_col &gt;= image_size) <span class="comment">// left/right split of the kernel</span></div><div class="line"><a name="l00633"></a><span class="lineno">  633</span>&#160;                                grid_col -= image_size;</div><div class="line"><a name="l00634"></a><span class="lineno">  634</span>&#160;</div><div class="line"><a name="l00635"></a><span class="lineno">  635</span>&#160;                            <span class="comment">// Use pointers here for faster access</span></div><div class="line"><a name="l00636"></a><span class="lineno">  636</span>&#160;                            <a class="code" href="types_8h.html#a1d2a57e59f061705d305d324a80d4ca1">cx_real_t</a>* conv_kernel_col = conv_kernel_array-&gt;colptr(j);</div><div class="line"><a name="l00637"></a><span class="lineno">  637</span>&#160;                            <a class="code" href="types_8h.html#a1d2a57e59f061705d305d324a80d4ca1">cx_real_t</a>* vis_grid_col = vis_grid.colptr(grid_col);</div><div class="line"><a name="l00638"></a><span class="lineno">  638</span>&#160;                            <a class="code" href="types_8h.html#a1d2a57e59f061705d305d324a80d4ca1">cx_real_t</a>* sampling_grid_col = NULL;</div><div class="line"><a name="l00639"></a><span class="lineno">  639</span>&#160;                            <span class="keywordflow">if</span> (generateBeam) {</div><div class="line"><a name="l00640"></a><span class="lineno">  640</span>&#160;                                sampling_grid_col = sampling_grid.colptr(grid_col);</div><div class="line"><a name="l00641"></a><span class="lineno">  641</span>&#160;                            }</div><div class="line"><a name="l00642"></a><span class="lineno">  642</span>&#160;</div><div class="line"><a name="l00643"></a><span class="lineno">  643</span>&#160;                            <span class="keywordtype">int</span> grid_row = gc_y - conv_support;</div><div class="line"><a name="l00644"></a><span class="lineno">  644</span>&#160;                            <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; kernel_size; ++i, ++grid_row) {</div><div class="line"><a name="l00645"></a><span class="lineno">  645</span>&#160;                                <span class="keywordflow">if</span> (grid_row &lt; 0) <span class="comment">// top/bottom split of the kernel. Halfplane gridding: kernel points in the negative halfplane are excluded</span></div><div class="line"><a name="l00646"></a><span class="lineno">  646</span>&#160;                                    <span class="keywordflow">continue</span>;</div><div class="line"><a name="l00647"></a><span class="lineno">  647</span>&#160;                                <span class="keywordflow">if</span> (grid_row &gt;= image_size) <span class="comment">// top/bottom split of the kernel. Halfplane gridding: kernel points touching the positive halfplane are used</span></div><div class="line"><a name="l00648"></a><span class="lineno">  648</span>&#160;                                    grid_row -= image_size;</div><div class="line"><a name="l00649"></a><span class="lineno">  649</span>&#160;                                <span class="comment">// The following condition is needed for the case of halfplane gridding, because only the top halfplane visibilities are convolved</span></div><div class="line"><a name="l00650"></a><span class="lineno">  650</span>&#160;                                <span class="keywordflow">if</span> (grid_row &lt; image_rows) {</div><div class="line"><a name="l00651"></a><span class="lineno">  651</span>&#160;                                    <a class="code" href="types_8h.html#a1d2a57e59f061705d305d324a80d4ca1">cx_real_t</a> kernel_val = conv_kernel_col[i] * vis_weight;</div><div class="line"><a name="l00652"></a><span class="lineno">  652</span>&#160;                                    assert(arma::is_finite(kernel_val));</div><div class="line"><a name="l00653"></a><span class="lineno">  653</span>&#160;                                    vis_grid_col[grid_row] += vis_val * kernel_val;</div><div class="line"><a name="l00654"></a><span class="lineno">  654</span>&#160;                                    <span class="keywordflow">if</span> (generateBeam) {</div><div class="line"><a name="l00655"></a><span class="lineno">  655</span>&#160;                                        sampling_grid_col[grid_row] += kernel_val;</div><div class="line"><a name="l00656"></a><span class="lineno">  656</span>&#160;                                    }</div><div class="line"><a name="l00657"></a><span class="lineno">  657</span>&#160;                                }</div><div class="line"><a name="l00658"></a><span class="lineno">  658</span>&#160;                            }</div><div class="line"><a name="l00659"></a><span class="lineno">  659</span>&#160;                        }</div><div class="line"><a name="l00660"></a><span class="lineno">  660</span>&#160;                    }</div><div class="line"><a name="l00661"></a><span class="lineno">  661</span>&#160;                }</div><div class="line"><a name="l00662"></a><span class="lineno">  662</span>&#160;<span class="preprocessor">#ifdef APROJECTION</span></div><div class="line"><a name="l00663"></a><span class="lineno">  663</span>&#160;            }</div><div class="line"><a name="l00664"></a><span class="lineno">  664</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l00665"></a><span class="lineno">  665</span>&#160;<span class="preprocessor">#ifdef WPROJECTION</span></div><div class="line"><a name="l00666"></a><span class="lineno">  666</span>&#160;        }</div><div class="line"><a name="l00667"></a><span class="lineno">  667</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l00668"></a><span class="lineno">  668</span>&#160;<span class="preprocessor">#else</span></div><div class="line"><a name="l00669"></a><span class="lineno">  669</span>&#160;        <span class="comment">// Multi-threaded implementation of oversampled gridder (20-25% faster)</span></div><div class="line"><a name="l00670"></a><span class="lineno">  670</span>&#160;<span class="preprocessor">#ifdef WPROJECTION</span></div><div class="line"><a name="l00671"></a><span class="lineno">  671</span>&#160;        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> pi = 0; pi &lt; num_wplanes; pi++) {</div><div class="line"><a name="l00672"></a><span class="lineno">  672</span>&#160;            arma::uword vi_begin = w_planes_firstidx(pi);</div><div class="line"><a name="l00673"></a><span class="lineno">  673</span>&#160;            arma::uword vi_end = (pi == (num_wplanes - 1)) ? good_vis.n_elem : w_planes_firstidx(pi + 1);</div><div class="line"><a name="l00674"></a><span class="lineno">  674</span>&#160;</div><div class="line"><a name="l00675"></a><span class="lineno">  675</span>&#160;            <span class="keywordflow">if</span> (use_wproj) {</div><div class="line"><a name="l00676"></a><span class="lineno">  676</span>&#160;                <span class="keywordflow">if</span> (use_aproj) {</div><div class="line"><a name="l00677"></a><span class="lineno">  677</span>&#160;                    <span class="comment">// Generate new AA/W-kernel for A-projection</span></div><div class="line"><a name="l00678"></a><span class="lineno">  678</span>&#160;                    wide_imaging.generate_combined_w_aa_kernel(w_avg_values(pi), aa_kernel_img);</div><div class="line"><a name="l00679"></a><span class="lineno">  679</span>&#160;                } <span class="keywordflow">else</span> {</div><div class="line"><a name="l00680"></a><span class="lineno">  680</span>&#160;                    <span class="comment">// Generate new convolution kernel for W-projection</span></div><div class="line"><a name="l00681"></a><span class="lineno">  681</span>&#160;                    wide_imaging.generate_convolution_kernel_wproj(w_avg_values(pi), aa_kernel_img);</div><div class="line"><a name="l00682"></a><span class="lineno">  682</span>&#160;                }</div><div class="line"><a name="l00683"></a><span class="lineno">  683</span>&#160;            }</div><div class="line"><a name="l00684"></a><span class="lineno">  684</span>&#160;<span class="preprocessor">#else</span></div><div class="line"><a name="l00685"></a><span class="lineno">  685</span>&#160;        arma::uword vi_begin = 0;</div><div class="line"><a name="l00686"></a><span class="lineno">  686</span>&#160;        arma::uword vi_end = good_vis.n_elem;</div><div class="line"><a name="l00687"></a><span class="lineno">  687</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l00688"></a><span class="lineno">  688</span>&#160;<span class="preprocessor">#ifdef APROJECTION</span></div><div class="line"><a name="l00689"></a><span class="lineno">  689</span>&#160;            <span class="keywordflow">for</span> (<span class="keywordtype">int</span> ts = 0; ts &lt; num_timesteps; ts++) {</div><div class="line"><a name="l00690"></a><span class="lineno">  690</span>&#160;                <span class="keywordflow">if</span> (use_aproj) {</div><div class="line"><a name="l00691"></a><span class="lineno">  691</span>&#160;                    <span class="comment">// Generate the AW - kernels</span></div><div class="line"><a name="l00692"></a><span class="lineno">  692</span>&#160;                    <span class="keywordtype">double</span> pangle = <a class="code" href="namespacestp.html#a723e08fc37f8606211f7abbda740d4e1">parangle</a>(lha_mean.at(ts), a_proj.obs_dec, a_proj.obs_lat);</div><div class="line"><a name="l00693"></a><span class="lineno">  693</span>&#160;                    <span class="keywordtype">double</span> pbmin = a_proj.mueller_term(0, 0);</div><div class="line"><a name="l00694"></a><span class="lineno">  694</span>&#160;                    arma::Mat&lt;real_t&gt; a_kernel = <a class="code" href="namespacestp.html#acd1a18f626d11eebaae47da542f454d1">rotate_matrix</a>(a_proj.mueller_term, pangle, pbmin, workarea_size);</div><div class="line"><a name="l00695"></a><span class="lineno">  695</span>&#160;                    <span class="comment">// Generate new convolution kernel for A-projection</span></div><div class="line"><a name="l00696"></a><span class="lineno">  696</span>&#160;                    wide_imaging.generate_convolution_kernel_aproj(a_kernel);</div><div class="line"><a name="l00697"></a><span class="lineno">  697</span>&#160;                }</div><div class="line"><a name="l00698"></a><span class="lineno">  698</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l00699"></a><span class="lineno">  699</span>&#160;<span class="preprocessor">#ifdef WPROJECTION</span></div><div class="line"><a name="l00700"></a><span class="lineno">  700</span>&#160;                <span class="keywordflow">if</span> (use_wproj) {</div><div class="line"><a name="l00701"></a><span class="lineno">  701</span>&#160;                    kernel_cache = wide_imaging.generate_kernel_cache();</div><div class="line"><a name="l00702"></a><span class="lineno">  702</span>&#160;                    conv_support = wide_imaging.get_trunc_conv_support();</div><div class="line"><a name="l00703"></a><span class="lineno">  703</span>&#160;                    assert(conv_support &gt; 0);</div><div class="line"><a name="l00704"></a><span class="lineno">  704</span>&#160;                    kernel_size = conv_support * 2 + 1;</div><div class="line"><a name="l00705"></a><span class="lineno">  705</span>&#160;                }</div><div class="line"><a name="l00706"></a><span class="lineno">  706</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l00707"></a><span class="lineno">  707</span>&#160;</div><div class="line"><a name="l00708"></a><span class="lineno">  708</span>&#160;                tbb::parallel_for(tbb::blocked_range&lt;size_t&gt;(0, kernel_size, 1), [&amp;](<span class="keyword">const</span> tbb::blocked_range&lt;size_t&gt;&amp; r) {</div><div class="line"><a name="l00709"></a><span class="lineno">  709</span>&#160;                    <span class="keywordflow">for</span> (arma::uword vi = vi_begin; vi &lt; vi_end; vi++) {</div><div class="line"><a name="l00710"></a><span class="lineno">  710</span>&#160;                        <span class="keyword">const</span> uint good_vis_val = good_vis[vi];</div><div class="line"><a name="l00711"></a><span class="lineno">  711</span>&#160;</div><div class="line"><a name="l00712"></a><span class="lineno">  712</span>&#160;<span class="preprocessor">#ifdef APROJECTION</span></div><div class="line"><a name="l00713"></a><span class="lineno">  713</span>&#160;                        <span class="comment">// Skip this visibility if using A-projection and it does not belong to the time interval</span></div><div class="line"><a name="l00714"></a><span class="lineno">  714</span>&#160;                        <span class="keywordflow">if</span> (use_aproj)</div><div class="line"><a name="l00715"></a><span class="lineno">  715</span>&#160;                            <span class="keywordflow">if</span> (vis_timesteps[vi] != ts)</div><div class="line"><a name="l00716"></a><span class="lineno">  716</span>&#160;                                <span class="keywordflow">continue</span>;</div><div class="line"><a name="l00717"></a><span class="lineno">  717</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l00718"></a><span class="lineno">  718</span>&#160;                        <span class="keywordflow">if</span> (good_vis_val == 0) {</div><div class="line"><a name="l00719"></a><span class="lineno">  719</span>&#160;                            <span class="keywordflow">continue</span>;</div><div class="line"><a name="l00720"></a><span class="lineno">  720</span>&#160;                        }</div><div class="line"><a name="l00721"></a><span class="lineno">  721</span>&#160;</div><div class="line"><a name="l00722"></a><span class="lineno">  722</span>&#160;                        <span class="keywordtype">int</span> gc_x = kernel_centre_on_grid(vi, 0);</div><div class="line"><a name="l00723"></a><span class="lineno">  723</span>&#160;                        <span class="keywordtype">int</span> gc_y = kernel_centre_on_grid(vi, 1);</div><div class="line"><a name="l00724"></a><span class="lineno">  724</span>&#160;                        uint cp_x = oversampled_offset.at(vi, 0);</div><div class="line"><a name="l00725"></a><span class="lineno">  725</span>&#160;                        uint cp_y = oversampled_offset.at(vi, 1);</div><div class="line"><a name="l00726"></a><span class="lineno">  726</span>&#160;                        <a class="code" href="types_8h.html#a1d2a57e59f061705d305d324a80d4ca1">cx_real_t</a> vis_val = <a class="code" href="types_8h.html#a1d2a57e59f061705d305d324a80d4ca1">cx_real_t</a>(vis[vi]);</div><div class="line"><a name="l00727"></a><span class="lineno">  727</span>&#160;                        <span class="keyword">const</span> <a class="code" href="types_8h.html#ab46614359717672dc9a4eed4669be6e6">real_t</a> vis_weight = vis_weights[vi];</div><div class="line"><a name="l00728"></a><span class="lineno">  728</span>&#160;<span class="preprocessor">#ifdef WPROJECTION</span></div><div class="line"><a name="l00729"></a><span class="lineno">  729</span>&#160;                        <span class="keywordtype">double</span> w_lambda_val = w_lambda.at(vi);</div><div class="line"><a name="l00730"></a><span class="lineno">  730</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l00731"></a><span class="lineno">  731</span>&#160;</div><div class="line"><a name="l00732"></a><span class="lineno">  732</span>&#160;                        <span class="comment">// If good_vis[vi] is 2, add also conjugate visibility</span></div><div class="line"><a name="l00733"></a><span class="lineno">  733</span>&#160;                        <span class="keywordflow">for</span> (uint gv = 0; gv &lt; good_vis_val; gv++) {</div><div class="line"><a name="l00734"></a><span class="lineno">  734</span>&#160;</div><div class="line"><a name="l00735"></a><span class="lineno">  735</span>&#160;                            <span class="keywordflow">if</span> (gv) {</div><div class="line"><a name="l00736"></a><span class="lineno">  736</span>&#160;                                gc_x = -kernel_centre_on_grid(vi, 0) + image_size;</div><div class="line"><a name="l00737"></a><span class="lineno">  737</span>&#160;                                gc_y = -kernel_centre_on_grid(vi, 1) + image_size;</div><div class="line"><a name="l00738"></a><span class="lineno">  738</span>&#160;                                <span class="keywordflow">if</span> (oversampling &gt; 1) {</div><div class="line"><a name="l00739"></a><span class="lineno">  739</span>&#160;                                    cp_x = -oversampled_offset.at(vi, 0) + oversampling;</div><div class="line"><a name="l00740"></a><span class="lineno">  740</span>&#160;                                    cp_y = -oversampled_offset.at(vi, 1) + oversampling;</div><div class="line"><a name="l00741"></a><span class="lineno">  741</span>&#160;                                }</div><div class="line"><a name="l00742"></a><span class="lineno">  742</span>&#160;                                vis_val = std::conj(vis_val);</div><div class="line"><a name="l00743"></a><span class="lineno">  743</span>&#160;<span class="preprocessor">#ifdef WPROJECTION</span></div><div class="line"><a name="l00744"></a><span class="lineno">  744</span>&#160;                                w_lambda_val *= (-1);</div><div class="line"><a name="l00745"></a><span class="lineno">  745</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l00746"></a><span class="lineno">  746</span>&#160;                            }</div><div class="line"><a name="l00747"></a><span class="lineno">  747</span>&#160;</div><div class="line"><a name="l00748"></a><span class="lineno">  748</span>&#160;                            <span class="keywordtype">int</span> conv_col = ((gc_x - r.begin() + kernel_size) % kernel_size);</div><div class="line"><a name="l00749"></a><span class="lineno">  749</span>&#160;                            <span class="keywordflow">if</span> (conv_col &gt; conv_support)</div><div class="line"><a name="l00750"></a><span class="lineno">  750</span>&#160;                                conv_col -= kernel_size;</div><div class="line"><a name="l00751"></a><span class="lineno">  751</span>&#160;                            <span class="keywordtype">int</span> grid_col = (gc_x - conv_col);</div><div class="line"><a name="l00752"></a><span class="lineno">  752</span>&#160;</div><div class="line"><a name="l00753"></a><span class="lineno">  753</span>&#160;                            <span class="keywordflow">if</span> ((grid_col &lt; image_size) &amp;&amp; (grid_col &gt;= 0)) {</div><div class="line"><a name="l00754"></a><span class="lineno">  754</span>&#160;</div><div class="line"><a name="l00755"></a><span class="lineno">  755</span>&#160;                                assert(std::abs(conv_col) &lt;= conv_support);</div><div class="line"><a name="l00756"></a><span class="lineno">  756</span>&#160;                                assert(arma::uword(grid_col % kernel_size) == r.begin());</div><div class="line"><a name="l00757"></a><span class="lineno">  757</span>&#160;</div><div class="line"><a name="l00758"></a><span class="lineno">  758</span>&#160;                                <span class="comment">// Use pointers here for faster access</span></div><div class="line"><a name="l00759"></a><span class="lineno">  759</span>&#160;                                <a class="code" href="types_8h.html#a1d2a57e59f061705d305d324a80d4ca1">cx_real_t</a>* conv_kernel_array = kernel_cache(cp_y, cp_x).colptr(conv_support - conv_col);</div><div class="line"><a name="l00760"></a><span class="lineno">  760</span>&#160;                                <a class="code" href="types_8h.html#a1d2a57e59f061705d305d324a80d4ca1">cx_real_t</a>* vis_grid_col = vis_grid.colptr(grid_col);</div><div class="line"><a name="l00761"></a><span class="lineno">  761</span>&#160;                                <a class="code" href="types_8h.html#a1d2a57e59f061705d305d324a80d4ca1">cx_real_t</a>* sampling_grid_col = NULL;</div><div class="line"><a name="l00762"></a><span class="lineno">  762</span>&#160;                                <span class="keywordflow">if</span> (generateBeam) {</div><div class="line"><a name="l00763"></a><span class="lineno">  763</span>&#160;                                    sampling_grid_col = sampling_grid.colptr(grid_col);</div><div class="line"><a name="l00764"></a><span class="lineno">  764</span>&#160;                                }</div><div class="line"><a name="l00765"></a><span class="lineno">  765</span>&#160;</div><div class="line"><a name="l00766"></a><span class="lineno">  766</span>&#160;<span class="preprocessor">#ifdef WPROJECTION</span></div><div class="line"><a name="l00767"></a><span class="lineno">  767</span>&#160;                                <span class="keywordflow">if</span> (use_wproj &amp;&amp; (w_lambda_val &lt; 0.0)) {</div><div class="line"><a name="l00768"></a><span class="lineno">  768</span>&#160;                                    <span class="comment">// Pick the pre-generated kernel corresponding to the sub-pixel offset nearest to that of the visibility.</span></div><div class="line"><a name="l00769"></a><span class="lineno">  769</span>&#160;                                    <span class="keywordtype">int</span> grid_row = gc_y - conv_support;</div><div class="line"><a name="l00770"></a><span class="lineno">  770</span>&#160;                                    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; kernel_size; ++i, ++grid_row) {</div><div class="line"><a name="l00771"></a><span class="lineno">  771</span>&#160;                                        <span class="keywordflow">if</span> (grid_row &lt; 0)</div><div class="line"><a name="l00772"></a><span class="lineno">  772</span>&#160;                                            <span class="keywordflow">continue</span>;</div><div class="line"><a name="l00773"></a><span class="lineno">  773</span>&#160;                                        <span class="keywordflow">if</span> (grid_row &gt;= image_size)</div><div class="line"><a name="l00774"></a><span class="lineno">  774</span>&#160;                                            grid_row -= image_size;</div><div class="line"><a name="l00775"></a><span class="lineno">  775</span>&#160;                                        <span class="keywordflow">if</span> (grid_row &lt; image_rows) {</div><div class="line"><a name="l00776"></a><span class="lineno">  776</span>&#160;                                            <span class="keyword">const</span> <a class="code" href="types_8h.html#a1d2a57e59f061705d305d324a80d4ca1">cx_real_t</a> kernel_val = std::conj(conv_kernel_array[i]) * vis_weight;</div><div class="line"><a name="l00777"></a><span class="lineno">  777</span>&#160;                                            vis_grid_col[grid_row] += vis_val * kernel_val;</div><div class="line"><a name="l00778"></a><span class="lineno">  778</span>&#160;                                            <span class="keywordflow">if</span> (generateBeam) {</div><div class="line"><a name="l00779"></a><span class="lineno">  779</span>&#160;                                                sampling_grid_col[grid_row] += kernel_val;</div><div class="line"><a name="l00780"></a><span class="lineno">  780</span>&#160;                                            }</div><div class="line"><a name="l00781"></a><span class="lineno">  781</span>&#160;                                        }</div><div class="line"><a name="l00782"></a><span class="lineno">  782</span>&#160;                                    }</div><div class="line"><a name="l00783"></a><span class="lineno">  783</span>&#160;                                } <span class="keywordflow">else</span></div><div class="line"><a name="l00784"></a><span class="lineno">  784</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l00785"></a><span class="lineno">  785</span>&#160;                                {</div><div class="line"><a name="l00786"></a><span class="lineno">  786</span>&#160;                                    <span class="comment">// Pick the pre-generated kernel corresponding to the sub-pixel offset nearest to that of the visibility.</span></div><div class="line"><a name="l00787"></a><span class="lineno">  787</span>&#160;                                    <span class="keywordtype">int</span> grid_row = gc_y - conv_support;</div><div class="line"><a name="l00788"></a><span class="lineno">  788</span>&#160;                                    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; kernel_size; ++i, ++grid_row) {</div><div class="line"><a name="l00789"></a><span class="lineno">  789</span>&#160;                                        <span class="keywordflow">if</span> (grid_row &lt; 0)</div><div class="line"><a name="l00790"></a><span class="lineno">  790</span>&#160;                                            <span class="keywordflow">continue</span>;</div><div class="line"><a name="l00791"></a><span class="lineno">  791</span>&#160;                                        <span class="keywordflow">if</span> (grid_row &gt;= image_size)</div><div class="line"><a name="l00792"></a><span class="lineno">  792</span>&#160;                                            grid_row -= image_size;</div><div class="line"><a name="l00793"></a><span class="lineno">  793</span>&#160;                                        <span class="keywordflow">if</span> (grid_row &lt; image_rows) {</div><div class="line"><a name="l00794"></a><span class="lineno">  794</span>&#160;                                            <span class="keyword">const</span> <a class="code" href="types_8h.html#a1d2a57e59f061705d305d324a80d4ca1">cx_real_t</a> kernel_val = conv_kernel_array[i] * vis_weight;</div><div class="line"><a name="l00795"></a><span class="lineno">  795</span>&#160;                                            vis_grid_col[grid_row] += vis_val * kernel_val;</div><div class="line"><a name="l00796"></a><span class="lineno">  796</span>&#160;                                            <span class="keywordflow">if</span> (generateBeam) {</div><div class="line"><a name="l00797"></a><span class="lineno">  797</span>&#160;                                                sampling_grid_col[grid_row] += kernel_val;</div><div class="line"><a name="l00798"></a><span class="lineno">  798</span>&#160;                                            }</div><div class="line"><a name="l00799"></a><span class="lineno">  799</span>&#160;                                        }</div><div class="line"><a name="l00800"></a><span class="lineno">  800</span>&#160;                                    }</div><div class="line"><a name="l00801"></a><span class="lineno">  801</span>&#160;                                }</div><div class="line"><a name="l00802"></a><span class="lineno">  802</span>&#160;                            }</div><div class="line"><a name="l00803"></a><span class="lineno">  803</span>&#160;</div><div class="line"><a name="l00804"></a><span class="lineno">  804</span>&#160;                            <span class="comment">// This is for the cases when the kernel is split between the left and right margins</span></div><div class="line"><a name="l00805"></a><span class="lineno">  805</span>&#160;                            <span class="keywordflow">if</span> ((gc_x &gt;= (image_size - conv_support)) || (gc_x &lt; conv_support)) {</div><div class="line"><a name="l00806"></a><span class="lineno">  806</span>&#160;                                <span class="keywordflow">if</span> (gc_x &gt;= (image_size - conv_support)) {</div><div class="line"><a name="l00807"></a><span class="lineno">  807</span>&#160;                                    gc_x -= image_size;</div><div class="line"><a name="l00808"></a><span class="lineno">  808</span>&#160;                                    conv_col = ((gc_x - r.begin() + kernel_size * 2) % kernel_size);</div><div class="line"><a name="l00809"></a><span class="lineno">  809</span>&#160;                                    <span class="keywordflow">if</span> (conv_col &gt; conv_support)</div><div class="line"><a name="l00810"></a><span class="lineno">  810</span>&#160;                                        conv_col -= kernel_size;</div><div class="line"><a name="l00811"></a><span class="lineno">  811</span>&#160;                                    grid_col = (gc_x - conv_col);</div><div class="line"><a name="l00812"></a><span class="lineno">  812</span>&#160;                                    assert(std::abs(conv_col) &lt;= conv_support);</div><div class="line"><a name="l00813"></a><span class="lineno">  813</span>&#160;                                } <span class="keywordflow">else</span> {</div><div class="line"><a name="l00814"></a><span class="lineno">  814</span>&#160;                                    assert(gc_x &lt; conv_support);</div><div class="line"><a name="l00815"></a><span class="lineno">  815</span>&#160;                                    gc_x += image_size;</div><div class="line"><a name="l00816"></a><span class="lineno">  816</span>&#160;                                    conv_col = ((gc_x - r.begin() + kernel_size) % kernel_size);</div><div class="line"><a name="l00817"></a><span class="lineno">  817</span>&#160;                                    <span class="keywordflow">if</span> (conv_col &gt; conv_support)</div><div class="line"><a name="l00818"></a><span class="lineno">  818</span>&#160;                                        conv_col -= kernel_size;</div><div class="line"><a name="l00819"></a><span class="lineno">  819</span>&#160;                                    grid_col = (gc_x - conv_col);</div><div class="line"><a name="l00820"></a><span class="lineno">  820</span>&#160;                                    assert(std::abs(conv_col) &lt;= conv_support);</div><div class="line"><a name="l00821"></a><span class="lineno">  821</span>&#160;                                }</div><div class="line"><a name="l00822"></a><span class="lineno">  822</span>&#160;</div><div class="line"><a name="l00823"></a><span class="lineno">  823</span>&#160;                                <span class="keywordflow">if</span> ((grid_col &lt; image_size) &amp;&amp; (grid_col &gt;= 0)) {</div><div class="line"><a name="l00824"></a><span class="lineno">  824</span>&#160;</div><div class="line"><a name="l00825"></a><span class="lineno">  825</span>&#160;                                    <span class="comment">// Use pointers here for faster access</span></div><div class="line"><a name="l00826"></a><span class="lineno">  826</span>&#160;                                    <a class="code" href="types_8h.html#a1d2a57e59f061705d305d324a80d4ca1">cx_real_t</a>* conv_kernel_array = kernel_cache(cp_y, cp_x).colptr(conv_support - conv_col);</div><div class="line"><a name="l00827"></a><span class="lineno">  827</span>&#160;                                    <a class="code" href="types_8h.html#a1d2a57e59f061705d305d324a80d4ca1">cx_real_t</a>* vis_grid_col = vis_grid.colptr(grid_col);</div><div class="line"><a name="l00828"></a><span class="lineno">  828</span>&#160;                                    <a class="code" href="types_8h.html#a1d2a57e59f061705d305d324a80d4ca1">cx_real_t</a>* sampling_grid_col = NULL;</div><div class="line"><a name="l00829"></a><span class="lineno">  829</span>&#160;                                    <span class="keywordflow">if</span> (generateBeam) {</div><div class="line"><a name="l00830"></a><span class="lineno">  830</span>&#160;                                        sampling_grid_col = sampling_grid.colptr(grid_col);</div><div class="line"><a name="l00831"></a><span class="lineno">  831</span>&#160;                                    }</div><div class="line"><a name="l00832"></a><span class="lineno">  832</span>&#160;</div><div class="line"><a name="l00833"></a><span class="lineno">  833</span>&#160;<span class="preprocessor">#ifdef WPROJECTION</span></div><div class="line"><a name="l00834"></a><span class="lineno">  834</span>&#160;                                    <span class="keywordflow">if</span> (use_wproj &amp;&amp; (w_lambda_val &lt; 0.0)) {</div><div class="line"><a name="l00835"></a><span class="lineno">  835</span>&#160;                                        <span class="comment">// Pick the pre-generated kernel corresponding to the sub-pixel offset nearest to that of the visibility.</span></div><div class="line"><a name="l00836"></a><span class="lineno">  836</span>&#160;                                        <span class="keywordtype">int</span> grid_row = gc_y - conv_support;</div><div class="line"><a name="l00837"></a><span class="lineno">  837</span>&#160;                                        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; kernel_size; ++i, ++grid_row) {</div><div class="line"><a name="l00838"></a><span class="lineno">  838</span>&#160;                                            <span class="keywordflow">if</span> (grid_row &lt; 0)</div><div class="line"><a name="l00839"></a><span class="lineno">  839</span>&#160;                                                <span class="keywordflow">continue</span>;</div><div class="line"><a name="l00840"></a><span class="lineno">  840</span>&#160;                                            <span class="keywordflow">if</span> (grid_row &gt;= image_size)</div><div class="line"><a name="l00841"></a><span class="lineno">  841</span>&#160;                                                grid_row -= image_size;</div><div class="line"><a name="l00842"></a><span class="lineno">  842</span>&#160;                                            <span class="keywordflow">if</span> (grid_row &lt; image_rows) {</div><div class="line"><a name="l00843"></a><span class="lineno">  843</span>&#160;                                                <span class="keyword">const</span> <a class="code" href="types_8h.html#a1d2a57e59f061705d305d324a80d4ca1">cx_real_t</a> kernel_val = std::conj(conv_kernel_array[i]) * vis_weight;</div><div class="line"><a name="l00844"></a><span class="lineno">  844</span>&#160;                                                vis_grid_col[grid_row] += vis_val * kernel_val;</div><div class="line"><a name="l00845"></a><span class="lineno">  845</span>&#160;                                                <span class="keywordflow">if</span> (generateBeam) {</div><div class="line"><a name="l00846"></a><span class="lineno">  846</span>&#160;                                                    sampling_grid_col[grid_row] += kernel_val;</div><div class="line"><a name="l00847"></a><span class="lineno">  847</span>&#160;                                                }</div><div class="line"><a name="l00848"></a><span class="lineno">  848</span>&#160;                                            }</div><div class="line"><a name="l00849"></a><span class="lineno">  849</span>&#160;                                        }</div><div class="line"><a name="l00850"></a><span class="lineno">  850</span>&#160;                                    } <span class="keywordflow">else</span></div><div class="line"><a name="l00851"></a><span class="lineno">  851</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l00852"></a><span class="lineno">  852</span>&#160;                                    {</div><div class="line"><a name="l00853"></a><span class="lineno">  853</span>&#160;                                        <span class="comment">// Pick the pre-generated kernel corresponding to the sub-pixel offset nearest to that of the visibility.</span></div><div class="line"><a name="l00854"></a><span class="lineno">  854</span>&#160;                                        <span class="keywordtype">int</span> grid_row = gc_y - conv_support;</div><div class="line"><a name="l00855"></a><span class="lineno">  855</span>&#160;                                        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; kernel_size; ++i, ++grid_row) {</div><div class="line"><a name="l00856"></a><span class="lineno">  856</span>&#160;                                            <span class="keywordflow">if</span> (grid_row &lt; 0)</div><div class="line"><a name="l00857"></a><span class="lineno">  857</span>&#160;                                                <span class="keywordflow">continue</span>;</div><div class="line"><a name="l00858"></a><span class="lineno">  858</span>&#160;                                            <span class="keywordflow">if</span> (grid_row &gt;= image_size)</div><div class="line"><a name="l00859"></a><span class="lineno">  859</span>&#160;                                                grid_row -= image_size;</div><div class="line"><a name="l00860"></a><span class="lineno">  860</span>&#160;                                            <span class="keywordflow">if</span> (grid_row &lt; image_rows) {</div><div class="line"><a name="l00861"></a><span class="lineno">  861</span>&#160;                                                <span class="keyword">const</span> <a class="code" href="types_8h.html#a1d2a57e59f061705d305d324a80d4ca1">cx_real_t</a> kernel_val = conv_kernel_array[i] * vis_weight;</div><div class="line"><a name="l00862"></a><span class="lineno">  862</span>&#160;                                                vis_grid_col[grid_row] += vis_val * kernel_val;</div><div class="line"><a name="l00863"></a><span class="lineno">  863</span>&#160;                                                <span class="keywordflow">if</span> (generateBeam) {</div><div class="line"><a name="l00864"></a><span class="lineno">  864</span>&#160;                                                    sampling_grid_col[grid_row] += kernel_val;</div><div class="line"><a name="l00865"></a><span class="lineno">  865</span>&#160;                                                }</div><div class="line"><a name="l00866"></a><span class="lineno">  866</span>&#160;                                            }</div><div class="line"><a name="l00867"></a><span class="lineno">  867</span>&#160;                                        }</div><div class="line"><a name="l00868"></a><span class="lineno">  868</span>&#160;                                    }</div><div class="line"><a name="l00869"></a><span class="lineno">  869</span>&#160;                                }</div><div class="line"><a name="l00870"></a><span class="lineno">  870</span>&#160;                            }</div><div class="line"><a name="l00871"></a><span class="lineno">  871</span>&#160;                        }</div><div class="line"><a name="l00872"></a><span class="lineno">  872</span>&#160;                    }</div><div class="line"><a name="l00873"></a><span class="lineno">  873</span>&#160;                });</div><div class="line"><a name="l00874"></a><span class="lineno">  874</span>&#160;<span class="preprocessor">#ifdef APROJECTION</span></div><div class="line"><a name="l00875"></a><span class="lineno">  875</span>&#160;            }</div><div class="line"><a name="l00876"></a><span class="lineno">  876</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l00877"></a><span class="lineno">  877</span>&#160;<span class="preprocessor">#ifdef WPROJECTION</span></div><div class="line"><a name="l00878"></a><span class="lineno">  878</span>&#160;        }</div><div class="line"><a name="l00879"></a><span class="lineno">  879</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l00880"></a><span class="lineno">  880</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l00881"></a><span class="lineno">  881</span>&#160;    } <span class="keywordflow">else</span> {</div><div class="line"><a name="l00882"></a><span class="lineno">  882</span>&#160;        <span class="comment">// Exact gridder (slower but with more accuracy)</span></div><div class="line"><a name="l00883"></a><span class="lineno">  883</span>&#160;        <span class="keywordflow">for</span> (arma::uword vi = 0; vi &lt; good_vis.n_elem; vi++) {</div><div class="line"><a name="l00884"></a><span class="lineno">  884</span>&#160;            <span class="keywordflow">if</span> (good_vis[vi] == 0) {</div><div class="line"><a name="l00885"></a><span class="lineno">  885</span>&#160;                <span class="keywordflow">continue</span>;</div><div class="line"><a name="l00886"></a><span class="lineno">  886</span>&#160;            }</div><div class="line"><a name="l00887"></a><span class="lineno">  887</span>&#160;            <span class="keywordtype">int</span> gc_x = kernel_centre_on_grid(vi, 0);</div><div class="line"><a name="l00888"></a><span class="lineno">  888</span>&#160;            <span class="keywordtype">int</span> gc_y = kernel_centre_on_grid(vi, 1);</div><div class="line"><a name="l00889"></a><span class="lineno">  889</span>&#160;            arma::mat frac = uv_frac.row(vi);</div><div class="line"><a name="l00890"></a><span class="lineno">  890</span>&#160;            <a class="code" href="types_8h.html#a1d2a57e59f061705d305d324a80d4ca1">cx_real_t</a> vis_val = <a class="code" href="types_8h.html#a1d2a57e59f061705d305d324a80d4ca1">cx_real_t</a>(vis[vi]);</div><div class="line"><a name="l00891"></a><span class="lineno">  891</span>&#160;            <span class="keyword">const</span> <a class="code" href="types_8h.html#ab46614359717672dc9a4eed4669be6e6">real_t</a> vis_weight = vis_weights[vi];</div><div class="line"><a name="l00892"></a><span class="lineno">  892</span>&#160;</div><div class="line"><a name="l00893"></a><span class="lineno">  893</span>&#160;            <span class="comment">// If good_vis[vi] is 2, add also conjugate visibility</span></div><div class="line"><a name="l00894"></a><span class="lineno">  894</span>&#160;            <span class="keywordflow">for</span> (arma::uword gv = 0; gv &lt; good_vis[vi]; gv++) {</div><div class="line"><a name="l00895"></a><span class="lineno">  895</span>&#160;</div><div class="line"><a name="l00896"></a><span class="lineno">  896</span>&#160;                <span class="keywordflow">if</span> (gv == 1) {</div><div class="line"><a name="l00897"></a><span class="lineno">  897</span>&#160;                    gc_x = -kernel_centre_on_grid(vi, 0) + image_size;</div><div class="line"><a name="l00898"></a><span class="lineno">  898</span>&#160;                    gc_y = -kernel_centre_on_grid(vi, 1) + image_size;</div><div class="line"><a name="l00899"></a><span class="lineno">  899</span>&#160;                    frac *= (-1);</div><div class="line"><a name="l00900"></a><span class="lineno">  900</span>&#160;                    vis_val = std::conj(vis_val);</div><div class="line"><a name="l00901"></a><span class="lineno">  901</span>&#160;                }</div><div class="line"><a name="l00902"></a><span class="lineno">  902</span>&#160;</div><div class="line"><a name="l00903"></a><span class="lineno">  903</span>&#160;                <span class="comment">// Exact gridding is used, i.e. the kernel is recalculated for each visibility, with</span></div><div class="line"><a name="l00904"></a><span class="lineno">  904</span>&#160;                <span class="comment">// precise sub-pixel offset according to that visibility&#39;s UV co-ordinates.</span></div><div class="line"><a name="l00905"></a><span class="lineno">  905</span>&#160;                arma::mat normed_kernel_array = <a class="code" href="namespacestp.html#a1dec62be138cc7a88f2fb0eebae6c63e">make_kernel_array</a>(kernel_creator, conv_support, frac);</div><div class="line"><a name="l00906"></a><span class="lineno">  906</span>&#160;</div><div class="line"><a name="l00907"></a><span class="lineno">  907</span>&#160;                <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j = 0; j &lt; kernel_size; j++) {</div><div class="line"><a name="l00908"></a><span class="lineno">  908</span>&#160;                    <span class="keywordtype">int</span> grid_col = gc_x - conv_support + j;</div><div class="line"><a name="l00909"></a><span class="lineno">  909</span>&#160;                    <span class="keywordflow">if</span> (grid_col &lt; 0) <span class="comment">// left/right split of the kernel</span></div><div class="line"><a name="l00910"></a><span class="lineno">  910</span>&#160;                        grid_col += image_size;</div><div class="line"><a name="l00911"></a><span class="lineno">  911</span>&#160;                    <span class="keywordflow">if</span> (grid_col &gt;= image_size) <span class="comment">// left/right split of the kernel</span></div><div class="line"><a name="l00912"></a><span class="lineno">  912</span>&#160;                        grid_col -= image_size;</div><div class="line"><a name="l00913"></a><span class="lineno">  913</span>&#160;</div><div class="line"><a name="l00914"></a><span class="lineno">  914</span>&#160;                    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; kernel_size; i++) {</div><div class="line"><a name="l00915"></a><span class="lineno">  915</span>&#160;                        <span class="keywordtype">int</span> grid_row = gc_y - conv_support + i;</div><div class="line"><a name="l00916"></a><span class="lineno">  916</span>&#160;                        <span class="keywordflow">if</span> (grid_row &lt; 0) <span class="comment">// top/bottom split of the kernel. Halfplane gridding: kernel points in the negative halfplane are excluded</span></div><div class="line"><a name="l00917"></a><span class="lineno">  917</span>&#160;                            grid_row += image_size;</div><div class="line"><a name="l00918"></a><span class="lineno">  918</span>&#160;                        <span class="keywordflow">if</span> (grid_row &gt;= image_size) <span class="comment">// top/bottom split of the kernel. Halfplane gridding: kernel points touching the positive halfplane are used</span></div><div class="line"><a name="l00919"></a><span class="lineno">  919</span>&#160;                            grid_row -= image_size;</div><div class="line"><a name="l00920"></a><span class="lineno">  920</span>&#160;                        <span class="comment">// The following condition is needed for the case of halfplane gridding, because only the top halfplane visibilities are convolved</span></div><div class="line"><a name="l00921"></a><span class="lineno">  921</span>&#160;                        <span class="keywordflow">if</span> (grid_row &lt; image_rows) {</div><div class="line"><a name="l00922"></a><span class="lineno">  922</span>&#160;                            <span class="keyword">const</span> <a class="code" href="types_8h.html#a1d2a57e59f061705d305d324a80d4ca1">cx_real_t</a> kernel_val = vis_weight * normed_kernel_array.at(i, j);</div><div class="line"><a name="l00923"></a><span class="lineno">  923</span>&#160;                            vis_grid(grid_row, grid_col) += (vis_val * kernel_val);</div><div class="line"><a name="l00924"></a><span class="lineno">  924</span>&#160;                            <span class="keywordflow">if</span> (generateBeam) {</div><div class="line"><a name="l00925"></a><span class="lineno">  925</span>&#160;                                sampling_grid(grid_row, grid_col) += kernel_val;</div><div class="line"><a name="l00926"></a><span class="lineno">  926</span>&#160;                            }</div><div class="line"><a name="l00927"></a><span class="lineno">  927</span>&#160;                        }</div><div class="line"><a name="l00928"></a><span class="lineno">  928</span>&#160;                    }</div><div class="line"><a name="l00929"></a><span class="lineno">  929</span>&#160;                }</div><div class="line"><a name="l00930"></a><span class="lineno">  930</span>&#160;            }</div><div class="line"><a name="l00931"></a><span class="lineno">  931</span>&#160;        }</div><div class="line"><a name="l00932"></a><span class="lineno">  932</span>&#160;    }</div><div class="line"><a name="l00933"></a><span class="lineno">  933</span>&#160;</div><div class="line"><a name="l00934"></a><span class="lineno">  934</span>&#160;    <span class="keywordflow">return</span> std::move(GridderOutput(vis_grid, sampling_grid, sample_grid_total));</div><div class="line"><a name="l00935"></a><span class="lineno">  935</span>&#160;}</div><div class="line"><a name="l00936"></a><span class="lineno">  936</span>&#160;}</div><div class="line"><a name="l00937"></a><span class="lineno">  937</span>&#160;</div><div class="line"><a name="l00938"></a><span class="lineno">  938</span>&#160;<span class="preprocessor">#endif </span><span class="comment">/* GRIDDER_H */</span><span class="preprocessor"></span></div><div class="ttc" id="namespacestp_html_a39093b21b3a22c0e0afcef9127a185f6"><div class="ttname"><a href="namespacestp.html#a39093b21b3a22c0e0afcef9127a185f6">stp::bounds_check_kernel_centre_locations</a></div><div class="ttdeci">void bounds_check_kernel_centre_locations(arma::uvec &amp;good_vis, const arma::imat &amp;kernel_centre_on_grid, int image_size, int support)</div><div class="ttdoc">bounds_check_kernel_centre_locations function </div><div class="ttdef"><b>Definition:</b> gridder.cpp:136</div></div>
<div class="ttc" id="namespacestp_html_a404fa9ce3a8e0427915ba3ac3aea9a16"><div class="ttname"><a href="namespacestp.html#a404fa9ce3a8e0427915ba3ac3aea9a16">stp::ImgDomKernel</a></div><div class="ttdeci">arma::Col&lt; real_t &gt; ImgDomKernel(const T &amp;kernel_creator, size_t kernel_size, bool normalize=false, bool analytic_gcf=false, FFTRoutine r_fft=FFTRoutine::FFTW_ESTIMATE_FFT)</div><div class="ttdoc">Computes the image-domain 1D kernel using the forward fast fourier transform or the analytic definiti...</div><div class="ttdef"><b>Definition:</b> conv_func.h:352</div></div>
<div class="ttc" id="global__macros_8h_html_a360486057265fd50c2351b9b11dab52b"><div class="ttname"><a href="global__macros_8h.html#a360486057265fd50c2351b9b11dab52b">STPLIB_DEBUG</a></div><div class="ttdeci">#define STPLIB_DEBUG(logger,...)</div><div class="ttdef"><b>Definition:</b> global_macros.h:17</div></div>
<div class="ttc" id="classstp_1_1_gridder_output_html_a7de6a41a043d64b12e4b583e612e868c"><div class="ttname"><a href="classstp_1_1_gridder_output.html#a7de6a41a043d64b12e4b583e612e868c">stp::GridderOutput::GridderOutput</a></div><div class="ttdeci">GridderOutput(MatStp&lt; cx_real_t &gt; &amp;in_vis_grid, MatStp&lt; cx_real_t &gt; &amp;in_sampling_grid, double in_sampling_total)</div><div class="ttdoc">Constructor - initializes members. </div><div class="ttdef"><b>Definition:</b> gridder.h:41</div></div>
<div class="ttc" id="namespacestp_html_a464d541245c3d8f9ea82f5d2d5484c98"><div class="ttname"><a href="namespacestp.html#a464d541245c3d8f9ea82f5d2d5484c98">stp::FFTRoutine</a></div><div class="ttdeci">FFTRoutine</div><div class="ttdoc">Enum of available FFT algorithms. </div><div class="ttdef"><b>Definition:</b> types.h:44</div></div>
<div class="ttc" id="namespacestp_html_a723e08fc37f8606211f7abbda740d4e1"><div class="ttname"><a href="namespacestp.html#a723e08fc37f8606211f7abbda740d4e1">stp::parangle</a></div><div class="ttdeci">double parangle(double ha, double dec_d, double lat_d)</div><div class="ttdoc">Compute parallatic angle for beam rotation. </div><div class="ttdef"><b>Definition:</b> aw_projection.cpp:485</div></div>
<div class="ttc" id="types_8h_html_a1d2a57e59f061705d305d324a80d4ca1"><div class="ttname"><a href="types_8h.html#a1d2a57e59f061705d305d324a80d4ca1">cx_real_t</a></div><div class="ttdeci">std::complex&lt; double &gt; cx_real_t</div><div class="ttdef"><b>Definition:</b> types.h:18</div></div>
<div class="ttc" id="namespacestp_html_ad2191add2b4abbc6ff7cb8c4102097ca"><div class="ttname"><a href="namespacestp.html#ad2191add2b4abbc6ff7cb8c4102097ca">stp::calculate_oversampled_kernel_indices</a></div><div class="ttdeci">arma::imat calculate_oversampled_kernel_indices(arma::mat &amp;subpixel_coord, int oversampling)</div><div class="ttdoc">calculate_oversampled_kernel_indices function </div><div class="ttdef"><b>Definition:</b> gridder.cpp:153</div></div>
<div class="ttc" id="namespacestp_html_aae328999b307d32ea32e65caa64eac0b"><div class="ttname"><a href="namespacestp.html#aae328999b307d32ea32e65caa64eac0b">stp::make_1D_kernel</a></div><div class="ttdeci">arma::vec make_1D_kernel(const T &amp;kernel_creator, int support, const double offset, int oversampling=1, bool pad=false, bool normalize=true)</div><div class="ttdoc">Make 1D Kernel Array. </div><div class="ttdef"><b>Definition:</b> conv_func.h:320</div></div>
<div class="ttc" id="namespacestp_html_ad75e5145b07b51b813ec9eaa95e5ac93"><div class="ttname"><a href="namespacestp.html#ad75e5145b07b51b813ec9eaa95e5ac93">stp::convert_to_halfplane_visibilities</a></div><div class="ttdeci">void convert_to_halfplane_visibilities(arma::mat &amp;uv_lambda, arma::cx_mat &amp;vis, int kernel_support, arma::uvec &amp;good_vis)</div><div class="ttdoc">Convert visibilities for half-plane gridding and mark the ones that need to be duplicated. </div><div class="ttdef"><b>Definition:</b> gridder.cpp:10</div></div>
<div class="ttc" id="namespacestp_html_ac088200d449ac7f780530a45d80f9775"><div class="ttname"><a href="namespacestp.html#ac088200d449ac7f780530a45d80f9775">stp::average_w_planes</a></div><div class="ttdeci">void average_w_planes(arma::mat w_lambda, const arma::uvec &amp;good_vis, int num_wplanes, arma::vec &amp;w_avg_values, arma::ivec &amp;w_planes_firstidx, bool median)</div><div class="ttdoc">Divides the w plane into sections, averaging each section. </div><div class="ttdef"><b>Definition:</b> gridder.cpp:67</div></div>
<div class="ttc" id="structstp_1_1_a___projection_pars_html"><div class="ttname"><a href="structstp_1_1_a___projection_pars.html">stp::A_ProjectionPars</a></div><div class="ttdoc">A-projection settings. </div><div class="ttdef"><b>Definition:</b> types.h:243</div></div>
<div class="ttc" id="namespacestp_html_a8135d9e95f2df8f47c170daa507a5a7a"><div class="ttname"><a href="namespacestp.html#a8135d9e95f2df8f47c170daa507a5a7a">stp::convolve_to_grid</a></div><div class="ttdeci">GridderOutput convolve_to_grid(const T &amp;kernel_creator, const int support, int image_size, arma::mat uv_lambda, arma::cx_mat vis, arma::mat vis_weights, bool kernel_exact=true, int oversampling=1, bool shift_uv=true, bool halfplane_gridding=true, const W_ProjectionPars &amp;w_proj=W_ProjectionPars(), arma::vec w_lambda=arma::vec(), double cell_size=0.0, bool analytic_gcf=true, FFTRoutine r_fft=FFTRoutine::FFTW_ESTIMATE_FFT, const A_ProjectionPars &amp;a_proj=A_ProjectionPars())</div><div class="ttdoc">Grid visibilities using convolutional gridding. </div><div class="ttdef"><b>Definition:</b> gridder.h:218</div></div>
<div class="ttc" id="classstp_1_1_gridder_output_html"><div class="ttname"><a href="classstp_1_1_gridder_output.html">stp::GridderOutput</a></div><div class="ttdoc">The gridder output class. </div><div class="ttdef"><b>Definition:</b> gridder.h:31</div></div>
<div class="ttc" id="namespacestp_html_a464d541245c3d8f9ea82f5d2d5484c98a1551a8f00e3ff5f46b18636fb963ad8c"><div class="ttname"><a href="namespacestp.html#a464d541245c3d8f9ea82f5d2d5484c98a1551a8f00e3ff5f46b18636fb963ad8c">stp::FFTRoutine::FFTW_ESTIMATE_FFT</a></div></div>
<div class="ttc" id="namespacestp_html_a19e8b064e439617289907aeed2c00c76"><div class="ttname"><a href="namespacestp.html#a19e8b064e439617289907aeed2c00c76">stp::populate_kernel_cache</a></div><div class="ttdeci">arma::field&lt; arma::Mat&lt; cx_real_t &gt; &gt; populate_kernel_cache(const T &amp;kernel_creator, const int support, const int oversampling, const bool pad=false, const bool normalize=true)</div><div class="ttdoc">populate_kernel_cache function </div><div class="ttdef"><b>Definition:</b> gridder.h:76</div></div>
<div class="ttc" id="namespacestp_html_acd1a18f626d11eebaae47da542f454d1"><div class="ttname"><a href="namespacestp.html#acd1a18f626d11eebaae47da542f454d1">stp::rotate_matrix</a></div><div class="ttdeci">arma::Mat&lt; real_t &gt; rotate_matrix(const arma::mat &amp;in_m, double angle, double cval, int out_size)</div><div class="ttdef"><b>Definition:</b> matrix_math.cpp:610</div></div>
<div class="ttc" id="global__macros_8h_html_acd403c01031d455af6f542e322f9a7b3"><div class="ttname"><a href="global__macros_8h.html#acd403c01031d455af6f542e322f9a7b3">TIMESTAMP_IMAGER</a></div><div class="ttdeci">#define TIMESTAMP_IMAGER</div><div class="ttdef"><b>Definition:</b> global_macros.h:29</div></div>
<div class="ttc" id="aw__projection_8h_html"><div class="ttname"><a href="aw__projection_8h.html">aw_projection.h</a></div><div class="ttdoc">Classes and function prototypes of aw_projection. </div></div>
<div class="ttc" id="classstp_1_1_mat_stp_html"><div class="ttname"><a href="classstp_1_1_mat_stp.html">stp::MatStp&lt; cx_real_t &gt;</a></div></div>
<div class="ttc" id="classstp_1_1_gridder_output_html_a875fc3decf005dff279ed0d43195942b"><div class="ttname"><a href="classstp_1_1_gridder_output.html#a875fc3decf005dff279ed0d43195942b">stp::GridderOutput::GridderOutput</a></div><div class="ttdeci">GridderOutput()=default</div><div class="ttdoc">Default constructor. </div></div>
<div class="ttc" id="gridder_8h_html_ad560e7fb8564c991d39374775a382e80"><div class="ttname"><a href="gridder_8h.html#ad560e7fb8564c991d39374775a382e80">arc_sec_to_rad</a></div><div class="ttdeci">#define arc_sec_to_rad(value)</div><div class="ttdef"><b>Definition:</b> gridder.h:20</div></div>
<div class="ttc" id="structstp_1_1_w___projection_pars_html"><div class="ttname"><a href="structstp_1_1_w___projection_pars.html">stp::W_ProjectionPars</a></div><div class="ttdoc">W-projection settings. </div><div class="ttdef"><b>Definition:</b> types.h:171</div></div>
<div class="ttc" id="classstp_1_1_gridder_output_html_a02d28321016ab51f04ecb17431583d8c"><div class="ttname"><a href="classstp_1_1_gridder_output.html#a02d28321016ab51f04ecb17431583d8c">stp::GridderOutput::sampling_grid</a></div><div class="ttdeci">MatStp&lt; cx_real_t &gt; sampling_grid</div><div class="ttdef"><b>Definition:</b> gridder.h:55</div></div>
<div class="ttc" id="classstp_1_1_gridder_output_html_a49a6dc4b250eff5150ec560daf3c33f5"><div class="ttname"><a href="classstp_1_1_gridder_output.html#a49a6dc4b250eff5150ec560daf3c33f5">stp::GridderOutput::vis_grid</a></div><div class="ttdeci">MatStp&lt; cx_real_t &gt; vis_grid</div><div class="ttdef"><b>Definition:</b> gridder.h:51</div></div>
<div class="ttc" id="namespacestp_html"><div class="ttname"><a href="namespacestp.html">stp</a></div><div class="ttdef"><b>Definition:</b> ccl.cpp:17</div></div>
<div class="ttc" id="classstp_1_1_gridder_output_html_a7e3e3dc1f24e7c5e3caff9611bd0e298"><div class="ttname"><a href="classstp_1_1_gridder_output.html#a7e3e3dc1f24e7c5e3caff9611bd0e298">stp::GridderOutput::sample_grid_total</a></div><div class="ttdeci">double sample_grid_total</div><div class="ttdef"><b>Definition:</b> gridder.h:59</div></div>
<div class="ttc" id="types_8h_html_ab46614359717672dc9a4eed4669be6e6"><div class="ttname"><a href="types_8h.html#ab46614359717672dc9a4eed4669be6e6">real_t</a></div><div class="ttdeci">double real_t</div><div class="ttdef"><b>Definition:</b> types.h:17</div></div>
<div class="ttc" id="namespacestp_html_a1dec62be138cc7a88f2fb0eebae6c63e"><div class="ttname"><a href="namespacestp.html#a1dec62be138cc7a88f2fb0eebae6c63e">stp::make_kernel_array</a></div><div class="ttdeci">arma::mat make_kernel_array(const T &amp;kernel_creator, int support, const arma::mat &amp;offset, int oversampling=1, bool pad=false, bool normalize=true)</div><div class="ttdoc">Make 2D Kernel Array. </div><div class="ttdef"><b>Definition:</b> conv_func.h:280</div></div>
</div><!-- fragment --></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.14
</small></address>
</body>
</html>
